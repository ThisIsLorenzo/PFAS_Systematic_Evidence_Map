---
title: "Code_pilot"
author: "L. Ricolfi"
date: "25/11/2022"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

# Information

The following Rmarkdown provides the code workflow for data manipulation and visualization.

Project title: PFAS exposure of humans, animals and environmental compartments: an evidence review map and bibliometric analysis

-   **Objective 1. Mapping: What evidence on PFAS has been synthesized?** I aim to reveal what areas in the realm of PFAS health-related and environmental research have been synthesized the most and where syntheses of evidence are lacking.

-   **Objective 2. Critical appraisal: How robust are syntheses of PFAS evidence?** I will examine the included syntheses for their reporting quality and potential biases, in order to assess reliability of reviews' conclusions, reveal syntheses that should be re-done, and highlight the aspects of review methodology that need to be improved.

-   **Objective 3. Bibliometrics: How is synthesized PFAS evidence connected?** I will examine which countries and institutions are mostly involved in secondary PFAS research and what do the networks between these institutions look like.

# Setup

Set global code chunk parameters and load packages.

```{r setup, include = TRUE}

knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE)

pacman::p_load(tidyverse, #includes ggplot2, dplyr, and tidyr. Used for data manipulation, cleaning, and visualization.
               here, #for files loading and saving.
               stringr, #for working with strings
               knitr, #for dynamic report generation
               formatR, #for formatting R code
               forcats, #for working with categorical data
               ggplot2, #for  data visualization
               hrbrthemes,#for additional themes for ggplot2 visualizations
               patchwork, #for combining multiple ggplot2 plots into one
               bibliometrix, #for bibliometric analysis
               igraph, #for creating and analyzing graph data
               xtable, #to export tables to LaTeX, HTML, or other formats
               kableExtra, #for creating tables for knitr and other R Markdown documents
               rotl,#for working with and visualizing data from the "R package Open Tree of Life (rotl)" package
               ochRe,
               ggalluvial,
               RColorBrewer,
               circlize,
               wesanderson,
               bibtex) #for working with and visualizing data from the "OpenCoEHST" package
```

Set Palettes

```{r}
#Seta a general palette
cbp1 <- c("#707070",
          "#999999",
          "#CCCCCC",
          "#F5F5F5")
          
#Set a palette for Review Subjects
cbp2 <- c("#A29F15",#Green is often associated with nature and life, making it fitting for the category of humans
          "#938274",#Brown is a common color for animals, representing their fur or feathers
          "#3C7A89",#Blue is commonly associated with the sky and sea, making it fitting for the category of the environment
          "#B8B8B8")#Grey is a neutral color
          
#Set a palette for PFAS one/multiple
cbp3 <- c("#D2664B",
          "#E6AF2E",
          "#B8B8B8")
          
#Set a palette for transparency and MASTAR2 assessment
cbp4 <- c("#588157",
                   "#E6AF2E",
          "#DE6449",
          "#B8B8B8")
          
my_palette <- brewer.pal(n = 10, name = "Set3")

```

# Load  data

Manually extracted pilot data is stored in four separate **.csv** files representing different aspects of the data (extracted via structured predefined Google Forms - one per table). Additional fixed table stores pre-extracted data on PFAS types included in this map.

Bibliographic data records are exported from Scopus (including cited references field) in .bib format and locally saved as **scopus.bib**.

A list of included studies during the search of all types of reviews for supplementary bibliometric analyses is included in **main_all_types_reviews.csv**

```{r create bibliometric data, eval=FALSE}
#converting the bibliometric data in .bib format to a dataframe
bib_data <- convert2df(here("data","scopus.bib"), dbsource = "scopus", format = "bibtex")
#dim(bib_data) #169 rows 35 columns

#extracting information from the "AU1_CO" and "AU_CO" fields of the bibliographic database and to create new variables from these fields, separated by ";". The new columns are added to the dataframe bib_data.
bib_data <- metaTagExtraction(bib_data, Field = "AU1_CO",
                          sep = ";")
bib_data <- metaTagExtraction(bib_data, Field = "AU_CO", sep = ";")
dim(bib_data)
#saving the combined bibliometric data
write.csv(bib_data, file = "data/bib.csv")
```

```{r load all data}
# Data from .csv file - main data sheet
mdata <- read_csv(here("data","main.csv"), skip = 0)
#dim(mdata) #175 rows 38 columns

# Data from .csv file - PFAS_types sheet:
ptdata <- read_csv(here("data","pfas_types.csv"), skip = 0) 
#dim(ptdata) #175 rows 5 columns
# change to long format (one type per row - one or multiple rows per study):
ptdata <- ptdata %>% separate_rows(PFAS_type, sep=', ')
#dim(ptdata) #1032 rows 5 columns

# Critical apprisal(AMSTAR2) from .csv file:
qdata <- read_csv(here("data", "amstar2.csv"), skip = 0)
#dim(qdata) #175 rows 36 columns

# Data from .csv file - PFAS_info sheet:
pidata <- read_csv(here("data","pfas_info.csv"), skip = 0) 
#dim(pidata) #35 rows 7 columns

# Data from .csv file - Species_info sheet
spdata <- read_csv(here("data","species.csv"), skip = 0) 
#dim(spdata) #541 rows 5 columns

mdata_all_types <- read_csv(here("data","main_all_types_review.csv"), skip = 0) 
# dim(mdata_all_types) #530 rows 21 columns
bib_data <- read.csv(here("data", "bib.csv"))
#dim(bib_data) #169 rows 36 columns
```

# Data Cleaning and Tiding

```{r merge data}
mdata <- 
  mdata %>%
  select(-ends_with("checked")) %>% # Remove columns ending with "checked" 
  select(-("Timestamp")) %>% # Remove "Timestamp" columns
  select(-starts_with("Initials")) %>%  # Remove columns starting with "Initials"
  select(-ends_with("comment")) %>% # Remove columns ending with "comment"
  drop_na(Author_year) %>% #remove last two rows because empty
  mutate(Journal = tolower(Journal))  #remove capital letters
#dim(mdata) #183 rows 30 columns

spdata <- 
  spdata %>%
  select(-ends_with("checked")) %>% 
  select(-ends_with("comment"))
#dim(spdata) #541 rows 4 columns

ptdata <- 
  ptdata %>%
  select(-ends_with("checked")) %>%
  select(-ends_with("comment")) %>% 
  select(-("Timestamp")) %>%
  select(-starts_with("Initials")) %>% 
  mutate(PFAS_type = case_when(
    PFAS_type == "6:2 Cl-PFESA/F-53B" ~ "6:2 Cl-PFESA",
    PFAS_type == "HFPO-DA/GenX" ~ "GenX",
    PFAS_type == "All PFAS" ~ "PFAS",
    TRUE ~ PFAS_type
  ))
#dim(ptdata) #1090 rows 2 columns

pidata <- 
  pidata %>% 
  select(-ends_with("comment"))
```

# Merge data stored across tables

The data stored across multiple flat spreadsheets needs merged for some of the analyses.
```{r}
#Merge main data with species info
mspdata <- left_join(mdata, spdata, by = "Study_ID")
#dim(mspdata) #692 rows 33 columns
#names(mspdata)
#str(mspdata)
#View(mspdata)

# Merge PFAS types data with PFAS info and then with main data
ptidata <- left_join(ptdata, pidata, by = "PFAS_type")
#dim(ptidata) #1090 rows 7 columns
#names(ptidata)
#str(ptidata)
#View(ptidata)

mpidata <- left_join(mdata, ptidata, by = "Study_ID")
#dim(mpidata) #1090 rows 36 columns
#names(mpidata)
#str(mpidata)
#View(mpidata)

# Merge main data with quality data
mqdata <- left_join(mdata, qdata, by = "Study_ID")
```

# DOIs string
The following chunk creates the search string to find all our included SRs on Scopus.

```{r}
# Get all the unique DOIs in the mdata table
dois <- unique(mdata$DOI)
# Create a search string for each DOI
doi_strings <- paste("DOI(", dois, ")", sep = "")
# Combine all the search strings with "OR"
search_string <- paste(doi_strings, collapse = " OR ")
# Print the final search string
cat(search_string)
```


# Summary table of all included systematic reviews (SRs) in the evidence review map

```{r simple table of included studies}

mdata <- mdata[order(mdata$Study_ID),] #Order the table by Study_ID


mdata2 <- mdata %>% 
  separate(Author_year, c("First_author", "Publication_year"), sep = "_") %>% 
  filter(First_author != "NA") #Create two new columns (i.e., 'First_author' and 'Publication_year') containing the first and second elements of the 'Author_year' column, respectively.

#Make the table
knitr::kable(select(mdata2,
                    First_author,
                    Publication_year,
                    Paper_title,
                    DOI), caption = "Table of included SRs") %>%
  kable_paper(bootstrap_options = "striped", full_width = F) #%>% 
 #save_kable(here("R_data", "table1.html"), self_contained = T)

```

Summary tables of all included reviews (all types) in the supplementary bibliometric analyses

```{r}
mdata_all_types <- mdata_all_types[order(mdata_all_types$key),] #Order the table by Rayyan key


mdata_all_types2 <- mdata_all_types %>% 
  separate(authors, c("First_author", "Co_authors"), sep = ",") #Create two new columns (i.e., 'First_author' and 'Publication_year') containing the first and second elements of the 'Author_year' column, respectively.

#Make the table
knitr::kable(select(mdata_all_types2,
                    First_author,
                    year,
                    title,
                    doi), caption = "Table of included SRs") %>%
  kable_paper(bootstrap_options = "striped", full_width = F)
```


# Alluvial plot

```{r, eval=FALSE}
#TODO
alluvial_mdata <- mdata %>% 
  group_by(Publication_year) %>% 
  mutate(n_pub = n())

mpidata <- left_join(mdata, ptidata, by = "Study_ID")

is_alluvia_form(as.data.frame(mpidata), axes = c(4,31,15,32), silent = TRUE)
#TRUE

ggplot(data = mpidata,
       aes(axis1 = Publication_year, 
           axis2 = n_pub,
           axis3 = Human_animal_environment,
           axis4 = PFAS_type,
           y = n)) +
  geom_alluvium(aes(fill = "red")) +
  geom_stratum() +
  geom_text(stat = "stratum",
            aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("Publication_year", "PFAS_type"),
                   expand = c(0.15, 0.05)) +
  theme_void()
```

# -----------------------------------------------------------------------

# Objective 1. Mapping

Main question: What evidence on PFAS has been synthesized?

Here we aim to reveal what areas in the realm of PFAS health-related and environmental research have been synthesized the most and where syntheses of evidence are lacking.

## Subjects

```{r plot main subjects barplot, height = 2, width = 8}
t_subject <- mdata %>%
  filter(Human_animal_environment != "NA") %>% #filter out NA
  count(Human_animal_environment) %>%
  mutate(percentage = round( n / sum(n) * 100))

t_subject$Human_animal_environment <-
  factor(t_subject$Human_animal_environment, levels = unique(t_subject$Human_animal_environment[order(t_subject$n, decreasing = FALSE)]))

subjects_levels_order <- 
  t_subject$Human_animal_environment[order(t_subject$n, decreasing = FALSE)] #save for another plot

#Barplot
p_subj <- ggplot(t_subject, aes(x = Human_animal_environment,
                                y = percentage)) +
  geom_col(aes(color = "black",
               fill = "#999999"), 
           alpha = 0.5,
          width = 0.8,
          size = 0.2) +
  theme_light() +
  labs(title = expression(bold("a)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Review subject") +
  scale_y_continuous(name = "Percentage of reviews (%)",
                     breaks = seq(0, 80, by = 10),
                     expand = c(0,1),
                     limits = c(0,80)) +
  scale_fill_manual(values = c("#999999")) +
  scale_color_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(n), x = Human_animal_environment), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
p_subj

# ggsave(here("R_data/final", "plot_subjects.png"),
#        width = 8,
#        height = 6)
```

## Subject and review type

```{r}
t_subject2 <- mdata %>%
  filter(Human_animal_environment != "NA") %>% #filter out NA
  count(Human_animal_environment, Review_type_claimed) %>%
  mutate(percentage = round( n / sum(n) * 100)) %>% 
  group_by(Human_animal_environment) %>% 
  mutate(n_tot = sum(n)) %>% 
  mutate(tot_percentage = sum(percentage))

t_subject2$Human_animal_environment <-
  factor(t_subject2$Human_animal_environment, levels = unique(t_subject2$Human_animal_environment[order(t_subject2$n_tot, decreasing = FALSE)]))

t_subject2 <- t_subject2 %>%
  mutate(Review_type_claimed = case_when(
    Review_type_claimed == "meta-analysis" ~ "MA",
    Review_type_claimed == "systematic review" ~ "SR",
    Review_type_claimed == "systematic evidence map" ~ "SEM",
    Review_type_claimed == "systematic review and meta-analysis" ~ "SR and MA",
    Review_type_claimed == "comprehensive review" ~ "CoR",
    Review_type_claimed == "scoping review" ~ "ScR",
    Review_type_claimed == "critical review" ~ "CrR",
    TRUE ~ Review_type_claimed
  ))

p_subj2 <- ggplot(t_subject2, aes(x = Human_animal_environment,
                                y = percentage)) +
  geom_col(aes(fill = Review_type_claimed,
               color = "black"), 
           alpha = 0.5,
          width = 0.8,
          size = 0.2) +
  theme_light() +
  labs(title = expression(bold("a)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Review subject") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 80, by = 10),
                     expand = c(0,1),
                     limits = c(0,80)) +
  scale_fill_manual(values = my_palette,
                    breaks = c("CoR",
                               "CrR",
                               "MA",
                               "review",
                               "ScR",
                               "SEM",
                               "SR",
                               "SR and MA")) +
  scale_color_manual(values = my_palette,
                     breaks = c("CR",
                               "critical review",
                               "MA",
                               "review",
                               "ScR",
                               "SEM",
                               "SR",
                               "SR and MA")) +
  geom_text(aes(fill = Review_type_claimed,
                label = paste0(n), x = Human_animal_environment), 
            position = position_stack(vjust = 0.5), 
            size = 2.7) + 
  geom_text(aes(label = paste("n tot =", sprintf("%.0f",n_tot)),
                x = Human_animal_environment,
                y =  max(tot_percentage)), 
            position = position_stack(vjust = 1.1), 
            size = 3,
            color = "black") +
  theme(title = element_text(size = 12),
        legend.position = "bottom",
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 11),
        legend.key.size = unit(0.4, "cm"),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        axis.text.y =  element_text(size = 10),
        axis.text.x =  element_text(size = 10),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "Review type claimed:")

p_subj2
```

## Topics (MeSH terms)

Each records usually has multiple associated MeSH terms, which are separated with a semicolon (or a semicolon with a newline symbol).\
The main topics of the article are denoted by the MeSH terms with asterisks \*, but some records will not have main topics, so its safer to ignore this information.\
Some MeSH headings also have qualifiers (sometimes called subheadings) - these are shown after a forward-slash and are used to "describe the specific aspects of the MeSH heading that are pertinent to the article" (<https://www.nlm.nih.gov/bsd/indexing/training/SUB_010.html>). MeSH terms and qualifiers could be analysed separately.

```{r plot main topics barplot prep, height = 4, width = 8}

# change to long format:
t_MESH <-
  mdata %>%
  select(Study_ID, MeSH_terms, Human_animal_environment) %>%
  separate_rows(MeSH_terms, sep = ";\\\n") %>%
  separate_rows(MeSH_terms, sep = "; ")
#bring to lower case and remove ending and trailing whitespace from character strings, single character vector:
tmesh <- 
  str_to_lower(trimws(t_MESH$MeSH_terms)) 
#remove star character:
tmesh <- 
  sub("[\\*]", "", tmesh) 

#separate terms before and after "/" into separate columns (headings and quantifiers, respectively)
tmesh2 <- 
  str_split_fixed(tmesh, " / ", n = 2)

Human_animal_environment <- t_MESH$Human_animal_environment
Study_ID <- t_MESH$Study_ID
#create a MeSH dataframe with three columns: terms, headings, qualifiers
t_MESH2 <- 
  bind_cols(tmesh, 
            tmesh2[,1],
            tmesh2[,2],
            Human_animal_environment,
            Study_ID)

colnames(t_MESH2) <- c("MeSH_terms",
                       "MeSH_headings",
                       "MeSH_qualifiers",
                       "Subject",
                       "Study_ID")

```

###Headings
```{r plot MeSH headings barplot, height = 4, width = 8}

MeSH_headings_counts <- t_MESH2[!duplicated(t_MESH2[, c("Study_ID", "MeSH_headings")]), ]

#count frequencies of headings
MeSH_headings_counts <- MeSH_headings_counts %>%
  filter(MeSH_headings != "NA") %>%
  count(MeSH_headings) %>% 
  mutate(percentage = round( n / 183 * 100))
  
MeSH_headings_counts$MeSH_headings <- factor(MeSH_headings_counts$MeSH_headings, levels = MeSH_headings_counts$MeSH_headings[order(MeSH_headings_counts$n, decreasing = FALSE)])

MeSH_headings_counts <- MeSH_headings_counts %>% 
  top_n(10, n)

MESH_headings_order <- 
  MeSH_headings_counts$MeSH_headings[order(MeSH_headings_counts$n, decreasing = FALSE)] #save for the next plot

# simple barplot with top 10 MESH headings
p_mesh_headings <- ggplot(MeSH_headings_counts, aes(x = MeSH_headings, y = percentage)) +
  geom_col(aes(color = "black",
               fill = "#999999"),
           alpha = 0.5,
          width = 0.8,
          size = 0.2) +
  theme_light() +
  labs(title = expression(bold("b)"))) +
  coord_flip() +
  scale_x_discrete(name = "MeSH headings") +
  scale_y_continuous(name = "Percentage of reviews (%)",
                     breaks = seq(0, 80, by = 10),
                     expand = c(0,1),
                     limits = c(0,80)) +
  scale_fill_manual(values = c("#999999")) +
  scale_color_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(n), x = MeSH_headings), 
            position = position_stack(vjust = 0.5), 
            size = 2) +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p_mesh_headings
# ggsave(here("R_data/final", "plot_mesh_headings.png"),
#        width = 8,
#        height = 6)
```

```{r plot MeSH headings with main review subjects barplot, height = 4, width = 8}

t_topic_subject <- t_MESH2[!duplicated(t_MESH2[, c("Study_ID", "MeSH_headings")]), ]

t_topic_subject <-
  t_topic_subject %>%
  filter(MeSH_headings != "NA") %>%
  count(MeSH_headings, Subject) %>% 
  mutate(percentage = round( n / 183 * 100)) %>% 
  group_by(MeSH_headings) %>%
  mutate(n_tot = sum(n)) %>%
  ungroup() %>% 
  mutate(percentage_tot = round( n_tot / 109 * 100)) %>% 
  filter(n_tot >= 20)

t_topic_subject$MeSH_headings <- fct_reorder(t_topic_subject$MeSH_headings, t_topic_subject$n, .fun = sum, .desc = FALSE)

p_mesh_subject <- ggplot(t_topic_subject, aes(x = MeSH_headings, 
                            y = percentage)) +
 theme_light() +
 labs(title = expression(bold("a)"))) +
 coord_flip()  +
 geom_col(aes(fill = fct_relevel(Subject, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans")),
              color = "black"), 
          alpha = 0.5,
          width = 0.8,
          size = 0.2) + 
  scale_fill_manual(values=cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  scale_color_manual(values = cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  scale_x_discrete(name = "MeSH headings") +
  scale_y_continuous(name = "Percentage of reviews (%)",
                     expand = c(0,1),
                     limits = c(0,80)) +
  geom_text(aes(fill = fct_relevel(Subject, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans")),
                label = paste0(n[Subject == Subject])
, x = MeSH_headings), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = c(0.7, 0.3),
       legend.box.background = element_rect(size = 0.1,
                                            colour = "black"),
       legend.title = element_blank(),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.title.x = element_blank(),
       axis.title.y = element_text(size = 7),
       axis.text = element_text(size = 6),
       legend.background = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
p_mesh_subject

# ggsave(here("R_data/final", "plot_mesh_h_subjects.png"),
#        width = 8,
#        height = 6)
```

###Qualifiers
```{r plot MeSH qualifiers barplot, height = 4, width = 8}

MeSH_qualifiers_counts <- t_MESH2[!duplicated(t_MESH2[, c("Study_ID", "MeSH_qualifiers")]), ]

#count frequencies of qualifiers
MeSH_qualifiers_counts <- MeSH_qualifiers_counts %>%
  filter(!is.na(MeSH_qualifiers) & MeSH_qualifiers != "") %>%
  count(MeSH_qualifiers) %>% 
  mutate(percentage = round( n / 183 * 100))

MeSH_qualifiers_counts$MeSH_qualifiers <- 
  factor(MeSH_qualifiers_counts$MeSH_qualifiers, levels = MeSH_qualifiers_counts$MeSH_qualifiers[order(MeSH_qualifiers_counts$n, decreasing = FALSE)])

MeSH_qualifiers_counts <- MeSH_qualifiers_counts %>% 
  top_n(10, n)

MESH_qualifiers_order <- 
  MeSH_qualifiers_counts$MeSH_qualifiers[order(MeSH_qualifiers_counts$n, decreasing = FALSE)] #save for the next plot

# simple barplot with MESH qualifiers
p_mesh_qualifiers <- ggplot(MeSH_qualifiers_counts, aes(x = MeSH_qualifiers,
                                       y = percentage)) +
  geom_col(aes(color = "black",
               fill = "#999999"), 
           alpha = 0.5,
          width = 0.8,
          size = 0.2) +
  theme_light() +
  labs(title = expression(bold("c)"))) +
  coord_flip() +
  scale_x_discrete(name = "MeSH qualifiers") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 80, by = 10),
                     expand = c(0,1),
                     limits = c(0,80)) +
  scale_fill_manual(values = c("#999999")) +
  scale_color_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(n), x = MeSH_qualifiers), 
            position = position_stack(vjust = 0.5), 
            size = 2) +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p_mesh_qualifiers
# ggsave(here("R_data/final", "plot_mesh_qualifiers.png"),
#        width = 8,
#        height = 6)
```

```{r, eval=FALSE}
MeSH_qualifiers_counts
# A tibble: 36 × 2
#    MeSH_qualifiers        n
#    <fct>              <int>
#  1 toxicity             168
#  2 analysis             114
#  3 adverse effects       73
#  4 drug effects          63
#  5 chemically induced    52
#  6 epidemiology          46
#  7 metabolism            42
#  8 chemistry             30
#  9 etiology              17
# 10 blood                 14
# … with 26 more rows
# ℹ Use `print(n = ...)` to see more rows
```

```{r plot MeSH qualifiers with main review subjects barplot, height = 4, width = 8}

t_topic_subject2 <- t_MESH2[!duplicated(t_MESH2[, c("Study_ID", "MeSH_qualifiers")]), ]

t_topic_subject2 <-
  t_topic_subject2 %>%
  filter(MeSH_qualifiers != "NA") %>% 
  filter(MeSH_qualifiers != "") %>% 
  count(MeSH_qualifiers, Subject) %>% 
  mutate(percentage = round( n / 183 * 100)) %>% 
  group_by(MeSH_qualifiers) %>%
  mutate(n_tot = sum(n)) %>%
  ungroup() %>% 
  mutate(percentage_tot = round( n_tot / 183 * 100)) %>% 
  filter(n_tot >= 7)

t_topic_subject2$MeSH_qualifiers <- fct_reorder(t_topic_subject2$MeSH_qualifiers, t_topic_subject2$n, .fun = sum, .desc = FALSE)

p_mesh_subject2 <- ggplot(t_topic_subject2, aes(x = MeSH_qualifiers, 
                            y = percentage)) +
 theme_light() +
 labs(title = expression(bold("b)"))) +
 coord_flip()  +
 geom_col(aes(fill = fct_relevel(Subject, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans")),
              color = "black"), 
          alpha = 0.5,
          width = 0.8,
          size = 0.2) +
  scale_fill_manual(values=cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  scale_color_manual(values = cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  scale_x_discrete(name = "MeSH qualifiers") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     expand = c(0,1),
                     limits = c(0,80)) +
  geom_text(aes(fill = fct_relevel(Subject, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans")),
                label = paste0(n[Subject == Subject])
, x = MeSH_qualifiers), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = c(0.7, 0.3),
       legend.box.background = element_rect(size = 0.1,
                                            colour = "black"),
       legend.title = element_blank(),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.title.x = element_text(size = 7),
       axis.title.y = element_text(size = 7),
       axis.text = element_text(size = 6),
       legend.background = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p_mesh_subject2
# ggsave(here("R_data/final", "plot_mesh_q_subjects.png"),
#        width = 8,
#        height = 6)
```

## Review type

```{r}
t_reviewtypes <- mdata %>%
  filter(Review_type_claimed != "NA") %>% #filter out NA
  count(Review_type_claimed) %>%
  mutate(percentage = round( n / sum(n) * 100))

t_reviewtypes$Review_type_claimed <-
  factor(t_reviewtypes$Review_type_claimed, levels = unique(t_reviewtypes$Review_type_claimed[order(t_reviewtypes$n, decreasing = FALSE)]))

p_rt <- ggplot(t_reviewtypes, aes(x = Review_type_claimed,
                                y = percentage)) +
  geom_col(aes(color = "black",
               fill = "#999999"), 
           alpha = 0.5,
          width = 0.8,
          size = 0.2) +
  theme_light() +
  labs(title = expression(bold("c)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Review type claimed") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 40, by = 10),
                     expand = c(0,1),
                     limits = c(0,40)) +
  scale_fill_manual(values = c("#999999")) +
  scale_color_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(n), x = Review_type_claimed), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
p_rt
```

## Review type and subject

```{r}
t_reviewtypes2 <- mdata %>%
  filter(Review_type_claimed != "NA") %>% #filter out NA
  count(Review_type_claimed, Human_animal_environment) %>%
  mutate(percentage = round( n / sum(n) * 100)) %>% 
  group_by(Review_type_claimed) %>% 
  mutate(n_tot = sum(n)) %>% 
  mutate(tot_percentage = sum(percentage))

t_reviewtypes2 <- t_reviewtypes2 %>%
  mutate(Review_type_claimed = case_when(
    Review_type_claimed == "meta-analysis" ~ "MA",
    Review_type_claimed == "systematic review" ~ "SR",
    Review_type_claimed == "systematic evidence map" ~ "SEM",
    Review_type_claimed == "systematic review and meta-analysis" ~ "SR and MA",
    Review_type_claimed == "comprehensive review" ~ "CoR",
    Review_type_claimed == "scoping review" ~ "ScR",
    Review_type_claimed == "critical review" ~ "CrR",
    TRUE ~ Review_type_claimed
  ))

t_reviewtypes2$Review_type_claimed <-
  factor(t_reviewtypes2$Review_type_claimed, levels = unique(t_reviewtypes2$Review_type_claimed[order(t_reviewtypes2$n_tot, decreasing = FALSE)]))

p_rt2 <- ggplot(t_reviewtypes2, aes(x = Review_type_claimed,
                                y = percentage)) +
  geom_col(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans")),
               color = "black"), 
           alpha = 0.5,
          width = 0.8,
          size = 0.2) +
  theme_light() +
  labs(title = expression(bold("c)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Review type claimed") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 40, by = 10),
                     expand = c(0,1),
                     limits = c(0,40)) +
  scale_fill_manual(values=cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  scale_color_manual(values=cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  geom_text(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans")),
                label = paste0(n), x = Review_type_claimed), 
            position = position_stack(vjust = 0.5), 
            size = 2.7) + 
  geom_text(aes(label = paste("n tot =", sprintf("%.0f",n_tot)),
                x = Review_type_claimed,
                y =  max(tot_percentage)), 
            position = position_stack(vjust = 1.1), 
            size = 3,
            color = "black") +
  theme(title = element_text(size = 12),
        legend.position = "bottom",
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 11),
        legend.key.size = unit(0.4, "cm"),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "Review subject:")

p_rt2
```

## Systematic approach and subject

```{r}
t_sys_appr <-
  mdata %>%
  filter(Systematic_approach != "NA") %>% 
  count(Systematic_approach, Human_animal_environment) %>%
  arrange(desc(n)) %>% 
  mutate(percentage = round( n / sum(n) * 100))
          
p_sys_appr <- 
  ggplot(t_sys_appr, aes(x = Systematic_approach,
                          y = percentage)) +
  ggtitle(expression(bold(")"))) +
  geom_col(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans")),
               color = "black"), 
           alpha = 0.5,
           width = 0.8,
           size = 0.2) +
  scale_fill_manual(values=cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
    scale_color_manual(values=cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  theme_light() +
  coord_flip() +
  scale_x_discrete(name = "Systematic approach") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 100, by = 10),
                     expand = c(0,1),
                     limits = c(0,100)) +
  geom_text(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                            "Environment", 
                                            "Animals", 
                                            "Humans")),
                label = paste0(n), x = Systematic_approach), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  theme(title = element_text(size = 9),
        legend.position = "right",
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "...")

p_sys_appr
# ggsave(here("R_data", "plot_pfas_focus.png"),
#        width = 8,
#        height = 6)
```

## Systematic approach and subject

```{r}
t_sys_appr2 <-
  mdata %>%
  filter(Systematic_approach != "NA") %>% 
  count(Human_animal_environment, Systematic_approach) %>%
  arrange(desc(n)) %>% 
  mutate(percentage = round( n / sum(n) * 100)) %>% 
  group_by(Human_animal_environment) %>% 
  mutate(n_tot = sum(n))

t_sys_appr2$Human_animal_environment <-
  factor(t_sys_appr2$Human_animal_environment, levels = unique(t_sys_appr2$Human_animal_environment[order(t_sys_appr2$n_tot, decreasing = FALSE)]))
          
p_sys_appr2 <- 
  ggplot(t_sys_appr2, aes(x = Human_animal_environment,
                          y = percentage)) +
  ggtitle(expression(bold("b)"))) +
  geom_col(aes(fill = fct_relevel(Systematic_approach, c("Yes", "No")),
               color = "black"), 
           alpha = 0.5,
           width = 0.8,
           size = 0.2) +
  scale_fill_manual(values=c("#DE6449", "#588157"),
                     breaks=c("No", "Yes")) +
    scale_color_manual(values=c("#DE6449", "#588157"),
                     breaks=c("No", "Yes")) +
  theme_light() +
  coord_flip() +
  scale_x_discrete(name = "Systematic approach") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 80, by = 10),
                     expand = c(0,1),
                     limits = c(0,80)) +
  geom_text(aes(fill = fct_relevel(Systematic_approach, c("Yes", "No")),
                label = paste0(n), x = Human_animal_environment), 
            position = position_stack(vjust = 0.5), 
            size = 2.7) + 
  theme(title = element_text(size = 12),
        legend.position = "bottom",
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 11),
        legend.key.size = unit(0.4, "cm"),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 10),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "Systematic approach:")

p_sys_appr2
# ggsave(here("R_data", "plot_pfas_focus.png"),
#        width = 8,
#        height = 6)
```

## Systematic approach and review type

```{r}
t_sys_appr2 <-
  mdata %>%
  filter(Systematic_approach != "NA") %>% 
  count(Systematic_approach, Review_type_claimed) %>%
  arrange(desc(n)) %>% 
  mutate(percentage = round( n / sum(n) * 100))
          
p_sys_appr2 <- 
  ggplot(t_sys_appr2, aes(x = Systematic_approach,
                          y = percentage)) +
  ggtitle(expression(bold(")"))) +
  geom_col(aes(fill = fct_relevel(Review_type_claimed, c("systematic evidence map",
                               "systematic review and meta-analysis",
                               "comprehensive review",
                               "meta-analysis",
                               "review",
                               "scoping review",
                               "critical review",
                               "systematic review")),
               color = "black"), 
           alpha = 0.5,
           width = 0.8,
           size = 0.2) +
  scale_fill_manual(values=my_palette,
                     breaks=c("systematic review",
                                                         "critical review",
                                                         "scoping review",
                                                         "review",
                                                         "meta-analysis",
                                                         "comprehensive review",
                                                         "systematic review and meta-analysis",
                                                         "systematic evidence map")) +
    scale_color_manual(values=my_palette,
                     breaks=c("systematic review",
                                                         "critical review",
                                                         "scoping review",
                                                         "review",
                                                         "meta-analysis",
                                                         "comprehensive review",
                                                         "systematic review and meta-analysis",
                                                         "systematic evidence map")) +
  theme_light() +
  coord_flip() +
  scale_x_discrete(name = "Systematic approach") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 100, by = 10),
                     expand = c(0,1),
                     limits = c(0,100)) +
  geom_text(aes(fill = fct_relevel(Review_type_claimed, c("systematic evidence map",
                               "systematic review and meta-analysis",
                               "comprehensive review",
                               "meta-analysis",
                               "review",
                               "scoping review",
                               "critical review",
                               "systematic review")),
                label = paste0(n), x = Systematic_approach), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  theme(title = element_text(size = 9),
        legend.position = "right",
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.y = element_text(size = 6),
        axis.text.x = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "...")

p_sys_appr2
# ggsave(here("R_data", "plot_pfas_focus.png"),
#        width = 8,
#        height = 6)
```

## Systematic approach and review type

```{r}
t_sys_appr3 <-
  mdata %>%
  filter(Systematic_approach != "NA") %>% 
  count(Review_type_claimed, Systematic_approach) %>%
  arrange(desc(n)) %>% 
  mutate(percentage = round( n / sum(n) * 100)) %>% 
  group_by(Review_type_claimed) %>% 
  mutate(n_tot = sum(n))
          
t_sys_appr3$Review_type_claimed <-
  factor(t_sys_appr3$Review_type_claimed, levels = unique(t_sys_appr3$Review_type_claimed[order(t_sys_appr3$n_tot, decreasing = FALSE)]))

p_sys_appr3 <- 
  ggplot(t_sys_appr3, aes(x = Review_type_claimed,
                          y = percentage)) +
  ggtitle(expression(bold("d)"))) +
  geom_col(aes(fill = fct_relevel(Systematic_approach, c("Yes", "No")),
               color = "black"), 
           alpha = 0.5,
           width = 0.8,
           size = 0.2) +
  scale_fill_manual(values=c("#DE6449", "#588157"),
                     breaks=c("No", "Yes")) +
    scale_color_manual(values=c("#DE6449", "#588157"),
                     breaks=c("No", "Yes")) +
  theme_light() +
  coord_flip() +
  scale_x_discrete(name = "Systematic approach") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 40, by = 10),
                     expand = c(0,1),
                     limits = c(0,40)) +
  geom_text(aes(fill = fct_relevel(Systematic_approach, c("Yes", "No")),
                label = paste0(n), x = Review_type_claimed), 
            position = position_stack(vjust = 0.5), 
            size = 2.7) + 
  theme(title = element_text(size = 12),
        legend.position = "bottom",
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 11),
        legend.key.size = unit(0.4, "cm"),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 10),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "Systematic approach:")

p_sys_appr3
# ggsave(here("R_data", "plot_pfas_focus.png"),
#        width = 8,
#        height = 6)
```

## COMBINED
```{r}
(p_subj2 / p_rt2)-(p_sys_appr2 / p_sys_appr3)
# ggsave(here("Figs", "Fig3.png"),
#        width = 11,
#        height = 8)

# (p_subj/p_rt) - (p_subj2/p_rt2)
# 
p_mesh_subject/p_mesh_subject2
# ggsave(here("Figs/Suppl_Figs", "MeSH_terms.png"),
#        width = 8,
#        height = 6)
```

## PFAS focus + how many
Are reviews focused specifically on PFAS or generically on POPs?
```{r}
t_PFASfocus <-
  mdata %>%
  filter(PFAS_focus != "NA") %>% 
  count(PFAS_focus) %>%
  arrange(desc(n))
          
p_PFAS_focus <- 
  ggplot(t_PFASfocus, aes(x = PFAS_focus,
                          y = n)) +
  
  ggtitle(expression(bold(")"))) +
  geom_col(width = 0.7,
           fill = "#999999") +
  theme_light() +
  coord_flip() +
  scale_x_discrete(name = "PFAS focus") +
  scale_y_continuous(name = "Number of reviews",
                     breaks = seq(0, 60, by = 20),
                     expand = c(0,1)) +
  geom_text(aes(label = paste0(round((n/sum(n))*100)), x = PFAS_focus), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  theme(legend.box.background = element_rect(colour = "black"), 
       axis.title.x = element_text(size = 8),
       axis.title.y = element_text(size = 8),
       axis.text = element_text(size = 7),
       title = element_text(size = 9),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p_PFAS_focus
# ggsave(here("R_data", "plot_pfas_focus.png"),
#        width = 8,
#        height = 6)
```

Focus on PFAS, or POPs, and how many PFAS:

```{r PFAS focus one_many barplot, height = 2, width = 8}
#str(mdata)
t2_PFASfocus <-
  mdata %>%
  count(PFAS_focus, PFAS_one_many) %>%
  arrange(desc(n)) %>% 
  filter(PFAS_focus != "NA") %>%  #filter out NA
  mutate(percentage = round( n / sum(n) * 100))

t2_PFASfocus$PFAS_one_many <- ifelse(t2_PFASfocus$PFAS_one_many == 'Not specified', 'NS', t2_PFASfocus$PFAS_one_many) #changing 'not specified' values into 'NS'

p2_PFAS_focus <- 
  ggplot(t2_PFASfocus, aes(x = PFAS_focus,
                          y = percentage)) +
  geom_col(aes(fill = fct_relevel(PFAS_one_many, c("NS",
                                                   "Multiple",
                                                   "One")),
               color = "black"), 
           alpha = 0.5,
           width = 0.8,
           size = 0.2) + 
  scale_fill_manual(values = cbp3, 
                    breaks=c('One', 
                             'Multiple',
                             'NS')) +
    scale_color_manual(values = cbp3,
                     breaks=c('One', 
                             'Multiple',
                             'NS')) +
  scale_x_discrete(name = "PFAS focus") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 70, by = 10),
                     expand = c(0,1),
                     limits = c(0,70)) +
  theme_light() +
  coord_flip() +
  geom_text(aes(fill = fct_relevel(PFAS_one_many, c("NS",
                                                    "Multiple", 
                                                    "One")),
                label = paste0(n), x = PFAS_focus),
            position = position_stack(vjust = 0.5),
            size = 2.7) +
  ggtitle(expression(bold("a)"))) +
  theme(
       title = element_text(size = 12),
       legend.position = "bottom",
       legend.title = element_text(size = 10),
       legend.text = element_text(size = 10), 
       legend.key.size = unit(0.3, "cm"),
       axis.title.x = element_text(size=10),
       axis.title.y = element_text(size=10),
       axis.text = element_text(size = 9),
       legend.background = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")
       ) +
  labs(fill = "PFAS reviewed:")

p2_PFAS_focus
# ggsave(here("R_data/final", "plot_pfas_focus2.png"),
#        width = 8,
#        height = 6)
```

```{r}
p_PFAS_focus/p2_PFAS_focus
# ggsave(here("R_data", "plot_pfas_focus_combined.png"),
#        width = 8,
#        height = 6)
```

```{r, eval=FALSE}
count(mdata, PFAS_focus)
# A tibble: 2 × 2
#   PFAS_focus     n
#   <chr>      <int>
# 1 No            52
# 2 Yes           57
count(mdata, PFAS_one_many)
# A tibble: 3 × 2
#   PFAS_one_many     n
#   <chr>         <int>
# 1 Multiple         74
# 2 Not specified    17
# 3 One              18
```

## PFAS focus + Subject

```{r plot PFAS focus by Human_animal_environment barplot, height = 2, width = 8}
# PFAS_one_many vs. Human_animal_environment contingency table
t1 <-
  mdata %>%
  count(Human_animal_environment, PFAS_one_many) %>% 
  mutate(percentage = round( n / sum(n) * 100))


pp1 <- ggplot(t1, aes(x = PFAS_one_many,
                      y = percentage)) +
 coord_flip()  +
 labs(title = expression(bold("b)"))) +
 geom_col(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                             "Environment",
                                                             "Animals", 
                                                             "Humans")),
              color = "black"),
          alpha = 0.5,
           width = 0.8,
           size = 0.2) +
  #geom_text(aes(label = n), position = position_stack(vjust = 0.2)) +
  scale_fill_manual(values=cbp2,
                    breaks=c("Humans", 
                             "Animals",
                             "Environment",
                             "Mixed")) +
  scale_color_manual(values = cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
 theme_light() +  
 theme(title = element_text(size = 12),
       legend.position = "bottom",
       legend.title = element_text(size = 10),
       legend.text = element_text(size = 10),
       legend.key.size = unit(0.3, "cm"),
       axis.title.x = element_text(size = 10),
       axis.title.y = element_text(size = 10),
       axis.text = element_text(size = 9),
       legend.background = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
 ylab("Article count") +
  scale_x_discrete(name = "Amount of PFAS reviewed") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 70, by = 10),
                     expand = c(0,1),
                     limits = c(0,70)) +
  geom_text(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                    "Environment",
                                                    "Animals",
                                                    "Humans")),
                label = paste0(n), x = PFAS_one_many),
            position = position_stack(vjust = 0.5),
            size = 2.7) +
  labs(fill = "Review subject:")

pp1

# ggsave(here("R_data/final","plot_PFAS_focus_subjects.png"),
#        width = 8,
#        height = 6)

```

## PFAS types

```{r plot PFAS types barplot, height = 8, width = 8}

#str(ptidata)
t_PFAStype <- ptidata %>%
  filter(PFAS_type != "NA") %>% #filter out NA
  count(PFAS_type) %>%
  mutate(percent = (n/183 * 100)) #109 is the number of SRs included in this review

t_PFAStype$PFAS_type <-
  factor(t_PFAStype$PFAS_type, levels = t_PFAStype$PFAS_type[order(t_PFAStype$n, decreasing = FALSE)])

PFAS_levels_order <-
  t_PFAStype$PFAS_type[order(t_PFAStype$n, decreasing = FALSE)] #save for another plot

# simple barplot with PFAS types
PFAS_types <- ggplot(t_PFAStype, aes(x = PFAS_type,
                       y = n)) +
  geom_col(aes(fill = ""), width = 0.7) +
  theme_light() +
  labs(title = expression("PFAS types reviewed")) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_y_continuous(name = "Reviews count",
                     expand = c(0,1)) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round((n/109)*100)), x = PFAS_type), 
            position = position_stack(vjust = 0.5), 
            size = 3) + 
  theme(legend.position = "none",
        axis.title.x = element_text(size = 11),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 7))
PFAS_types

# ggsave(here("R_data/final", "plot_pfas_types.png"),
#        width = 8,
#        height = 6)
```

```{r, circular barplot, eval = FALSE}
# # Get the name and the y position of each label
# label_data <- t_PFAStype %>% 
#   mutate(id = seq(1,29))
# # calculate the ANGLE of the labels
# number_of_bar <- nrow(label_data)
# angle <-  90 - 360 * (label_data$id-0.5) /number_of_bar
# # calculate the alignment of labels: right or left
# # If I am on the left part of the plot, my labels have currently an angle < -90
# label_data$hjust<-ifelse( angle < -90, 1, 0)
# # flip angle BY to make them readable
# label_data$angle<-ifelse(angle < -90, angle+180, angle)
# 
# # Start the plot
# p <- ggplot(label_data, aes(x= as.factor(id), y=n)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar
# 
# # This add the bars with a blue color
# geom_bar(stat="identity", fill=alpha("skyblue", 0.8)) +
# # Limits of the plot = very important. The negative value controls the size of the inner circle, the positive one is useful to add size over each bar
#   ylim(-80,120) +
#   
#   # Custom the theme: no axis title and no cartesian grid
#   theme_minimal() +
#   theme(
#     axis.text = element_blank(),
#     axis.title = element_blank(),
#     panel.grid = element_blank(),
#     plot.margin = unit(rep(-1,4), "cm")      # Adjust the margin to make in sort labels are not truncated!
#   ) +
#   
#   # This makes the coordinate polar instead of cartesian.
#   coord_polar(start = 0) +
#   
#   # Add the labels, using the label_data dataframe that we have created before
#   geom_text(data=label_data, aes(x=id,
#                                 y=n,
#                                 label=PFAS_type,
#                                 hjust=hjust),
#             color="black",
#             fontface="plain",
#             alpha=0.8,
#             size=3.5,
#             angle= label_data$angle,
#             inherit.aes = FALSE )
#  
# p
```



## PFAS types + Subject

```{r plot PFAS types by Human_animal_environment barplot, height = 8, width = 8}
#str(mpidata)
t_PFAStype <-
  mpidata %>%
  count(PFAS_type, Human_animal_environment) %>%
  arrange(desc(n)) %>%
  filter(PFAS_type != "NA") %>%  #filter out NA
  mutate(percentage = round( n / 183 * 100))
  
#t_PFAStype$PFAS_type <- factor(t_PFAStype$PFAS_type, levels = unique(t_PFAStype$PFAS_type[order(t_PFAStype$n, decreasing = FALSE)]))
t_PFAStype$PFAS_type <-
  factor(t_PFAStype$PFAS_type, levels = PFAS_levels_order) #use order from the previous graph


p_PFAStype <-
  ggplot(t_PFAStype, aes(x = PFAS_type,
                         y = percentage)) +
  labs(title = expression(bold("c)"))) +
  coord_flip()  +
  geom_col(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                              "Environment",
                                                              "Animals",
                                                              "Humans")),
               color = "black"), 
           alpha = 0.5,
           width = 0.8,
           size = 0.2) +
  theme_light() +
  scale_fill_manual(values=cbp2,
                    breaks=c("Humans",
                             "Animals",
                             "Environment",
                             "Mixed")) +
  scale_color_manual(values = cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  scale_x_discrete(name = "PFAS types") +
  scale_y_continuous(name = "Percentage of SRs (%)",
                     breaks = seq(0, 70, by = 10),
                     expand = c(0,1),
                     limits = c(0,70)) +
  geom_text(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                    "Environment",
                                                    "Animals",
                                                    "Humans")),
                label = paste0(round((n/109)*100)), x = PFAS_type),
            position = position_stack(vjust = 0.5),
            size = 2.7) +
  theme(
       title = element_text(size = 12),
       legend.position = c(0.6, 0.5),
       legend.box.background = element_rect(size = 0.1,
                                            colour = "black"),
       legend.title = element_blank(),
       legend.text = element_text(size = 10),
       legend.key.size = unit(0.4, "cm"),
       axis.title.x = element_text(size = 10),
       axis.title.y = element_text(size = 10),
       axis.text = element_text(size = 9),
       legend.background = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")
       )
p_PFAStype
# ggsave(here("R_data/final", "plot_pfas_subjects.png"),
#        width = 8,
#        height = 6)
```

##COMBINED
```{r}
(p2_PFAS_focus/pp1)-p_PFAStype
# ggsave(here("Figs", "Fig4.png"),
#        width = 9,
#        height = 6)
```


## Time-trends
### Overall

```{r area plots year, height = 2, width = 8}
trend_overall <- mdata %>% 
  count(Publication_year) %>% #counting the number of rows for each unique value of the "Publication_year"
  mutate(cumulative = cumsum(n)) #add a new column to the output of the previous step, named "cumulative", which contains the cumulative sum of the "n" column


tt1 <- trend_overall %>% 
  ggplot(aes(x = Publication_year,
             y = n)) + 
  labs(title = expression(bold("a)"))) +
  geom_col(aes(y = n),
           color = "black", 
           fill = "#999999",
           alpha = 0.5,
           width = 0.8,
           size = 0.3) + # add columns
  # geom_line(size = 0.3) + #add a line chart
  # geom_point(size = 1.5,
  #            shape = 19,
  #            fill = "white") + #add a scatter plot
  geom_text(aes(label = n,
                x = Publication_year, 
            y = n),
            size = 2,
            position = position_stack(vjust = 0.5)) + #add text labels to the ggplot object
  scale_x_continuous(#name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 60, by = 10),
                    expand = c(0,1),
                    minor_breaks = NULL) +
  theme_light() +
  theme(plot.title = element_text(size = 9), 
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_blank(),
       axis.title.y = element_text(size = 7), #add theme elements
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

tt1
# ggsave(here("R_data/final", "time_trend.png"),
#        width = 8,
#        height = 6)
```

Cumulative trend

```{r}
tt1.1 <- trend_overall %>%
  ggplot(aes(x = Publication_year,
             y = cumulative)) + 
  labs(title = expression(bold("a)"))) +
  geom_line(size = 0.3) +
  geom_point(size = 1, 
             shape = 19,
             fill = "white") +
  geom_area(fill = "grey", alpha = 0.2) +
  scale_x_continuous(#name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 190, by = 10),
                    minor_breaks = NULL,
                    expand = c(0.01,0.1)) +
  theme_light() +
  theme(plot.title = element_text(size = 9), 
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_blank(),
       axis.title.y = element_text(size = 7), #add theme elements
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
tt1.1
```

### Review types

```{r}
review_trend <- mdata %>% 
  group_by(Review_type_claimed) %>% 
  count(Publication_year)

review_trend <- review_trend %>%
  mutate(Review_type_claimed = case_when(
    Review_type_claimed == "meta-analysis" ~ "MA",
    Review_type_claimed == "systematic review" ~ "SR",
    Review_type_claimed == "systematic evidence map" ~ "SEM",
    Review_type_claimed == "systematic review and meta-analysis" ~ "SR and MA",
    Review_type_claimed == "comprehensive review" ~ "CoR",
    Review_type_claimed == "scoping review" ~ "ScR",
    Review_type_claimed == "critical review" ~ "CrR",
    TRUE ~ Review_type_claimed
  ))

tt2.1 <- review_trend %>%
  ggplot(aes(x = Publication_year,
             y = n
             )) +
  labs(title = expression(bold("a)"))) +
  geom_col(aes(
           fill = Review_type_claimed,
           color = "black"), 
           alpha = 0.5,
           width = 0.8,
           size = 0.2) +
  geom_text(aes(fill = Review_type_claimed,
                label = n, 
                x = Publication_year,
                y = n), 
            size = 2.5,
            position = position_stack(vjust = 0.5),
            color = "black") +
  scale_fill_manual(values = my_palette,
                    breaks = c("CoR",
                               "CrR",
                               "MA",
                               "review",
                               "ScR",
                               "SEM",
                               "SR",
                               "SR and MA")) +
  scale_color_manual(values = my_palette,
                     breaks = c("CoR",
                               "CrR",
                               "MA",
                               "review",
                               "ScR",
                               "SEM",
                               "SR",
                               "SR and MA")) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 190, by = 10),
                    expand = c(0,1),
                    minor_breaks = NULL) +
  theme_light() +
  theme(plot.title = element_text(size = 12),
        legend.position = "bottom",
       legend.title = element_text(size = 11),
       legend.text = element_text(size = 11),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 10,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10),
       axis.title.y = element_text(size = 10),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "Review type claimed:")

tt2.1

# ggsave(here("R_data/final", "time_trend_review_type.png"),
#        width = 8,
#        height = 6)
```



### SRs & MAs

```{r}
# mdata2 <- 
#   mdata %>%
#   separate_rows(Review_type_claimed, sep=";") #split the values in the "Review_type_claimed" column by ";" and create a new row for each value
# 
# mdata2$review_type <- ifelse(mdata2$Review_type_claimed == "systematic review"|
#                               mdata2$Review_type_claimed == "meta-analysis" ,
#                               mdata2$Review_type_claimed, "systematic review") #reduce the types of reviews in systematic and meta-analyses

srma_trend <- mdata %>% 
  group_by(Meta_analysis) %>%
  count(Publication_year)

tt2 <- srma_trend %>%
  ggplot(aes(x = Publication_year,
             y = n
             )) +
  labs(title = expression(bold("c)"))) +
  geom_col(aes(fill = fct_relevel(Meta_analysis, c("Yes","No")),
               color = "black"), 
           alpha = 0.3,
           width = 0.8,
           size = 0.2) +
  geom_text(aes(fill = fct_relevel(Meta_analysis, c("Yes","No")),
                label = n,
                x = Publication_year, 
                y = n), 
            size = 2.5,
            position = position_stack(vjust = 0.5),
            color = "black") +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 190, by = 10),
                    expand = c(0,1),
                    minor_breaks = NULL) +
  scale_fill_manual(values = c("#DE6449", "#588157"),
                    breaks = c("No","Yes")) +
  scale_color_manual(values = cbp1,
                     breaks = c("No","Yes")) +
  theme_light() +
  theme(plot.title = element_text(size = 12),
        legend.position = "bottom",
       legend.title = element_text(size = 11),
       legend.text = element_text(size = 11),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 10,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 10,
                                   hjust = 0.5),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "Quantitative synthesis:")

tt2
# ggsave(here("R_data/final", "time_trend_srs_mas.png"),
#        width = 8,
#        height = 6)
```

### Review subject

```{r}
trend_subjects <- mdata %>% 
  filter(Human_animal_environment != "Plants") %>% 
  group_by(Human_animal_environment) %>% 
  count(Publication_year)

#Set palette for Review Subjects
cbp2.1 <- c("#A29F15",
            "#B8B8B8",
            "#3C7A89",
            "#938274")

tt3 <-  trend_subjects %>%
  ggplot(aes(x = Publication_year,
             y = n)) +
  labs(title = expression(bold("b)"))) +
  geom_col(aes(
           fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                              "Environment",
                                                              "Animals",
                                                              "Humans")),
           color = "black"), 
           alpha = 0.3,
           width = 0.8,
           size = 0.2) +
  geom_text(aes(fill = fct_relevel(Human_animal_environment, c("Mixed",
                                                              "Environment",
                                                              "Animals",
                                                              "Humans")),
                label = n, x = Publication_year, y = n), 
            size = 2.5, 
            position = position_stack(vjust = 0.5),
            color = "black") +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 80, by = 10),
                    minor_breaks = NULL,
                    expand = c(0,1)
                    ) +
  scale_color_manual(values = cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  scale_fill_manual(values = cbp2,
                     breaks=c("Humans", 
                              "Animals", 
                              "Environment",
                              "Mixed")) +
  theme_light() + 
  theme(plot.title = element_text(size = 12),
        legend.position = "bottom",
        legend.title = element_text(size = 11),
       legend.text = element_text(size = 11),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 10,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "Review subject:")

tt3
# ggsave(here("R_data", "time_trend_subjects.png"),
#        width = 8,
#        height = 6)
```

### PFAS legacy and novel

```{r}
legacy_novel_trend <- mpidata[!duplicated(mpidata[, c("Study_ID", "Legacy_novel")]), ]

legacy_novel_trend <- legacy_novel_trend %>%
  drop_na(Legacy_novel) %>% 
  group_by(Study_ID) %>%
  summarise(Legacy_novel = ifelse(n_distinct(Legacy_novel) > 1, "legacy and novel", Legacy_novel[1]),
            Publication_year = first(Publication_year))
  

legacy_novel_trend <- legacy_novel_trend %>% 
  group_by(Legacy_novel) %>%
  count(Publication_year)

tt4 <- legacy_novel_trend %>%
  ggplot(aes(x = Publication_year,
             y = n
             )) +
  labs(title = expression(bold("d)"))) +
  geom_col(aes(fill = fct_relevel(Legacy_novel, c("NS",
                                                   "novel",
                                                    "legacy and novel",
                               "legacy")),
               color = "black"), 
           alpha = 0.3,
           width = 0.8,
           size = 0.2) +
  geom_text(aes(fill = fct_relevel(Legacy_novel, c("NS",
                                                   "novel",
                                                    "legacy and novel",
                               "legacy")),
                label = n,
                x = Publication_year, 
                y = n), 
            size = 2.5,
            position = position_stack(vjust = 0.5),
            color = "black") +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 190, by = 10),
                    expand = c(0,1),
                    minor_breaks = NULL) +
  scale_fill_manual(values = c("#335C67", "#FFF3B0", "#E09F3E", "grey"),
                    breaks = c("legacy",
                                                   "legacy and novel",
                                                    "novel",
                                                   "NS")) +
  scale_color_manual(values = cbp1,
                     breaks = c("legacy",
                                                   "legacy and novel",
                                                    "novel",
                                                   "NS")) +
  theme_light() +
  theme(plot.title = element_text(size = 12),
        legend.position = "bottom",
       legend.title = element_text(size = 11),
       legend.text = element_text(size = 11),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 10,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(fill = "PFAS reviewed:")

tt4
```


###COMBINED
```{r}
(tt2.1-tt3)/(tt2-tt4)
# ggsave(here("Figs", "Fig2.png"),
#        width = 11,
#        height = 8)
```

### Broad taxa

```{r}
spdata <- spdata[!duplicated(spdata[, c("Study_ID", "Species_scientific_name")]), ]
spdata$Broad_taxa2 <- ifelse(spdata$Class_scientific_name == "Aves"|
                              spdata$Class_scientific_name == "Mammalia" |
                              spdata$Class_scientific_name == "Actinopterygii",
                              spdata$Class_scientific_name, "Others")

spdata$Broad_taxa2 <- ifelse(spdata$Broad_taxa2 == "Aves", "Birds",
                      ifelse(spdata$Broad_taxa2 == "Mammalia", "Mammals",
                      ifelse(spdata$Broad_taxa2 == "Actinopterygii", "Ray-finned fish",
                             spdata$Broad_taxa2)))

spdata <- spdata[!duplicated(spdata[, c("Study_ID", "Broad_taxa2")]), ]

tt_taxa <- left_join(mdata, spdata, by = "Study_ID") %>%
  filter(!is.na(Broad_taxa2)) %>% 
  group_by(Broad_taxa2) %>% 
  count(Publication_year) %>%
  mutate(cumulative = cumsum(n))

time_trend_taxa <- tt_taxa %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Broad_taxa2, -cumulative))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = reorder(Broad_taxa2, -cumulative)), 
             size = 1, 
             shape = 21, 
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 22, by = 2),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(#plot.title = element_text(size = 9),
        legend.title = element_blank(),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 8),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Broad taxa")

time_trend_taxa
# ggsave(here("R_data", "time_trend_taxa.png"),
#        width = 8,
#        height = 6)
```

```{r}
count(mdata, Publication_year)
# A tibble: 11 × 2
#    Publication_year     n
#               <dbl> <int>
#  1             2011     1
#  2             2013     6
#  3             2014     5
#  4             2015     3
#  5             2016     6
#  6             2017     8
#  7             2018    11
#  8             2019    11
#  9             2020    15
# 10             2021    33
# 11             2022    10
```

### PFAS focus

```{r}
tt_pfas_focus <- mdata %>% 
  group_by(PFAS_focus) %>% 
  count(Publication_year)


tt4 <-  tt_pfas_focus %>%
  ggplot(aes(x = Publication_year,
             y = n)) +
  labs(title = expression(bold("a)"))) +
  geom_col(aes(
           fill = PFAS_focus,
           color = PFAS_focus), 
           alpha = 0.3,
           width = 0.8,
           size = 0.2) +
  # geom_line(size = 0.5) + 
  # geom_point(aes(color = PFAS_focus), 
  #            size = 1, 
  #            shape = 19, 
  #            fill = "white") +
  geom_text(aes(fill = fct_relevel(PFAS_focus, c("No",
                                                 "Yes")),
                label = n, 
                x = Publication_year,
                y = n), 
            size = 1.5, 
            position = position_stack(vjust = 0.5),
            color = "black") +
  scale_x_continuous(name = "Year",
                     breaks = c(seq(2008, 2022, by = 1)),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 50, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_fill_manual(values = c("#DE6449", "#588157"),
                    breaks = c("No","Yes")) +
  scale_color_manual(values = cbp1,
                     breaks = c("No","Yes")) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.position = "right",
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 5,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 7),
       axis.title.y = element_text(size = 8),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

tt4
# ggsave(here("R_data/final", "time_trend_pfas_focus.png"),
#        width = 8,
#        height = 6)
```

### PFAS how many

```{r}
tt_pfas_focus2 <- mdata %>% 
  group_by(PFAS_one_many) %>% 
  count(Publication_year) 

tt_pfas_focus2 <- tt_pfas_focus2 %>% 
  mutate(PFAS_one_many = ifelse(PFAS_one_many == "Not specified", "NS", PFAS_one_many))

tt5 <-  tt_pfas_focus2 %>%
  ggplot(aes(x = Publication_year,
             y = n)) +
  labs(title = expression(bold("b)"))) +
  geom_col(aes(
           fill = PFAS_one_many,
           color = "black"), 
           alpha = 0.3,
           width = 0.8,
           size = 0.2) +
  # geom_line(size = 0.5) + 
  # geom_point(aes(color = PFAS_one_many), 
  #            size = 1,
  #            shape = 19,
  #            fill = "white") +
  geom_text(aes(fill = fct_relevel(PFAS_one_many, c("Multiple",
                                                 "NS",
                                                 "One")),
                label = n, x = Publication_year, y = n), 
            size = 1.5, 
            position = position_stack(vjust = 0.5),
            color = "black") +
  scale_x_continuous(name = "Year",
                     breaks = c(seq(2008, 2022, by = 1)),
                     minor_breaks = NULL) +
  scale_y_continuous(#name = "Number of reviews",
                    breaks = seq(0, 80, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_manual(values = cbp1,
                     breaks = c("Multiple",
                                "NS",
                                "One")) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.position = "right",
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 5,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 7),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

tt5
# ggsave(here("R_data", "time_trend_pfas_focus2.png"),
#        width = 8,
#        height = 6)
```

### PFAS focus + how many

```{r}
pfas_focus3 <- mdata %>% 
  group_by(PFAS_focus, PFAS_one_many) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_pfas_focus3 <-  pfas_focus3 %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_focus, - cumulative))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = PFAS_focus), size = 1.5, shape = 21, fill = "white") +
  facet_wrap(~ PFAS_focus + PFAS_one_many) +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 110, by = 10),
                    minor_breaks = NULL
                    ) +
  ggtitle("Time trend") + 
  theme(plot.title = element_text(size = 12,
                                  hjust = 0.5),
       axis.text.x = element_text(size = 9,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 9,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 10,
                                   hjust = 0.5),
       legend.position = "none") 

t_pfas_focus3
# ggsave(here("R_data", "time_trend_pfas_focus3.png"),
#        width = 8,
#        height = 6)
```

### PFAS types

```{r}

tt_pfas_types <- mpidata[!duplicated(mpidata[, c("Study_ID", "PFAS_type")]), ]

trend_pfas_types <- tt_pfas_types %>% 
  filter(PFAS_type != "All PFAS") %>% 
  group_by(PFAS_type) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

tt6 <-  trend_pfas_types %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_type, -cumulative))) +
  labs(title = expression(bold("f)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = reorder(PFAS_type, -cumulative)),
             size = 1,
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 140, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_discrete(guide = guide_legend(ncol = 1)) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.title = element_blank(),
        legend.position = "right",
       legend.text = element_text(size = 4.5),
       legend.key.size = unit(0.15, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 8),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

tt6
# ggsave(here("R_data", "time_trend_pfas_types.png"),
#        width = 8,
#        height = 6)
```

### PFAS group

```{r}
tt_pfas_groups <- mpidata %>% 
  drop_na(PFAS_group) %>%
  distinct(Study_ID, Publication_year, PFAS_group) %>%
  group_by(PFAS_group) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_pfas_group <-  tt_pfas_groups %>%
  ggplot(aes(x = Publication_year,
             y = n,)) +
  labs(title = expression(bold(")"))) +
  geom_col(aes(
    fill = PFAS_group,
    color = PFAS_group),
    alpha = 0.3,
    width = 0.8,
    size = 0.2) +
  # geom_line(size = 0.7) + 
  # geom_point(aes(color = reorder(PFAS_group, -cumulative)), 
  #            size = 1.5,
  #            shape = 19, 
  #            fill = "white") +
  geom_text(aes(label = n,
                x = Publication_year,
                y = n), 
            size = 1.5, 
            position = position_stack(vjust = 0.5),
            color = "black") +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 190, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.title = element_blank(),
       legend.text = element_text(size = 7),
       legend.key.size = unit(0.4, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 8),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "PFAS group")

t_pfas_group
# ggsave(here("R_data", "time_trend_pfas_group.png"),
#        width = 8,
#        height = 6)
```

### PFAS group - semplified

```{r}
mpidata$PFAS_group2 <- ifelse(mpidata$PFAS_group == "Perfluoroalkane sulfonic acids (PFSA)" |
                              mpidata$PFAS_group == "Perfluoroalkyl carboxylic acids (PFCA)" ,
                              mpidata$PFAS_group, "Others")

mpidata$PFAS_group2 <- gsub("Perfluoroalkane sulfonic acids \\(PFSA\\)", "PFSA", mpidata$PFAS_group2)
mpidata$PFAS_group2 <- gsub("Perfluoroalkyl carboxylic acids \\(PFCA\\)", "PFCA", mpidata$PFAS_group2)

tt_pfas_groups2 <- mpidata[!duplicated(mpidata[, c("Study_ID", "PFAS_group2")]), ]

tt_pfas_groups2 <- tt_pfas_groups2 %>% 
  drop_na(PFAS_group2) %>%
  group_by(PFAS_group2) %>% 
  count(Publication_year)
  
tt7 <-  tt_pfas_groups2 %>%
  ggplot(aes(x = Publication_year,
             y = n)) +
  labs(title = expression(bold("c)"))) +
  geom_col(aes(
           fill = PFAS_group2,
           color = "black"), 
           alpha = 0.3,
           width = 0.8,
           size = 0.2) +
  # geom_line(size = 0.5) + 
  # geom_point(aes(color = reorder(PFAS_group2, -cumulative)), 
  #            size = 1, 
  #            shape = 19,
  #            fill = "white") +
  geom_text(aes(fill = fct_relevel(PFAS_group2, c("Others",
                                                 "PFCA",
                                                 "PFSA")),
                label = n, 
                x = Publication_year, 
                y = n), 
            size = 1.5, 
            position = position_stack(vjust = 0.5),
            color = "black") +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 100, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_manual(values = cbp1,
                     breaks = c("PFSA","PFCA", "Others")) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.position = "right",
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 7),
       axis.title.y = element_text(size = 7),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

tt7
# ggsave(here("R_data", "time_trend_pfas_group_semplified.png"),
#        width = 8,
#        height = 6)
```

### PFAS carbon chain length

```{r}
tt_pfas_ccl <- mpidata %>% 
  filter(!is.na(PFAS_carbon_chain)) %>% 
  distinct(Study_ID, Publication_year, PFAS_carbon_chain) %>% 
  group_by(PFAS_carbon_chain) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

tt8 <-  tt_pfas_ccl %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(PFAS_carbon_chain, -cumulative))) +
  labs(title = expression(bold("g)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = reorder(PFAS_carbon_chain, -cumulative)),
             size = 1, 
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 2, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 190, by = 10),
                    minor_breaks = NULL
                    ) +
  theme_light() +
  theme(plot.title = element_text(size = 9),
        legend.title = element_text(size = 7),
       legend.text = element_text(size = 6),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 6,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 6,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 8,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Carbon chain length")

tt8
# ggsave(here("R_data", "time_trend_pfas_ccc.png"),
#        width = 8,
#        height = 6)
```
### COMBINED
```{r}
(tt4-tt5)/tt7#-tt7)/(tt6-tt8)
# ggsave(here("Figs/Suppl_Figs", "SFig3.png"),
#        width = 8,
#        height = 8)
```


## Species

### Species

```{r}
t_sp <- mspdata[!duplicated(mspdata[, c("Study_ID", "Species_scientific_name")]), ] %>% 
  filter(Species_scientific_name != "NA" & Species_scientific_name != "na") %>% 
  count(Species_scientific_name) %>%
  arrange(desc(n))

t_sp$Species_scientific_name <-
  factor(t_sp$Species_scientific_name, levels = t_sp$Species_scientific_name[order(t_sp$n, decreasing = FALSE)])

species_levels_order <-
  t_sp$Species_scientific_name[order(t_sp$n, decreasing = FALSE)] #save for another plot

t_sp <- head(t_sp, n = 20)

sp1 <- ggplot(t_sp, aes(x = Species_scientific_name, 
                      y = n)) +
  geom_col(width = 0.7,
           fill = "#999999") +
  labs(title = expression(bold("b)"))) +
  theme_light() +
  coord_flip()  +
  scale_fill_brewer() +
  scale_fill_manual(values = c("#999999")) +
 scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 20, by = 2)) +
  scale_x_discrete(name = "Species scientific name") +
 theme_light() +
 theme(legend.position = "bottom",
       legend.box.background = element_rect(colour = "black"), 
       legend.title = element_text(size = 8),  
       legend.text=element_text(size = 8), 
       axis.title.x = element_text(size = 9), 
       axis.title.y = element_text(size = 9),
       axis.text = element_text(size = 8),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"),
       plot.title = element_text(size = 10))
sp1
# ggsave(here("R_data", "plot_top10_species.png"),
#        width = 8,
#        height = 6)
```

### Broad taxa

```{r}
# mspdata$Broad_taxa2 <- ifelse(mspdata$Class_scientific_name == "Aves"|
#                               mspdata$Class_scientific_name == "Mammalia" |
#                               mspdata$Class_scientific_name == "Actinopterygii",
#                               mspdata$Class_scientific_name, "Others")
# 
# mspdata$Broad_taxa2 <- ifelse(mspdata$Broad_taxa2 == "Aves", "Birds",
#                       ifelse(mspdata$Broad_taxa2 == "Mammalia", "Mammals",
#                       ifelse(mspdata$Broad_taxa2 == "Actinopterygii", "Fish",
#                              mspdata$Broad_taxa2)))



t_tx <- mspdata[!duplicated(mspdata[, c("Study_ID", "Class_scientific_name")]), ] %>% 
  filter(Class_scientific_name != "NA" & Class_scientific_name != "na") %>% 
  count(Class_scientific_name) %>%
  arrange(desc(n))

t_tx$Class_scientific_name <-
  factor(t_tx$Class_scientific_name, levels = t_tx$Class_scientific_name[order(t_tx$n, decreasing = FALSE)])

taxa_levels_order <-
  t_tx$Class_scientific_name[order(t_tx$n, decreasing = FALSE)] #save for another plot

sp2 <- ggplot(t_tx, aes(x = Class_scientific_name, 
                      y = n)) +
  geom_col(width = 0.7,
           fill = "#999999") +
  labs(title = expression(bold("a)"))) +
  theme_light() +
  coord_flip()  +
  scale_fill_brewer() +
  scale_fill_manual(values = c("#999999")) +
 scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 24, by = 2)) +
  scale_x_discrete(name = "Class scientific name") +
 theme_light() +
 theme(legend.position = "bottom",
       legend.box.background = element_rect(colour = "black"), 
       legend.title = element_text(size = 8),  
       legend.text = element_text(size = 8), 
       axis.title.x = element_text(size = 9), 
       axis.title.y = element_text(size = 9),
       axis.text = element_text(size = 8),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth = 0.2, 
                                      linetype = "dotted"),
       plot.title = element_text(size = 10))
sp2
# ggsave(here("R_data", "plot_top10_species.png"),
#        width = 8,
#        height = 6)
```



### Species + how many
*ALL MULTIPLE*
```{r species focus one_many barplot, height = 4, width = 8}
#str(mspdata)

t_spfocus <- mspdata[!duplicated(mspdata[, c("Study_ID", "Species_scientific_name")]), ] %>% 
  filter(Species_scientific_name != "NA") %>% 
  filter(Species_one_many != "NA") %>% 
  count(Species_scientific_name, Species_one_many) %>%
  arrange(desc(n))

t_spfocus$Species_scientific_name <-
  factor(t_spfocus$Species_scientific_name, levels = species_levels_order) #use order from the previous graph
t_spfocus <- t_spfocus %>% 
  filter(Species_scientific_name != "NA")

sp4 <- ggplot(t_spfocus, aes(x = Species_scientific_name, 
                      y = n)) +
  labs(title = expression(bold("d)"))) +
  geom_col(aes(fill = Species_one_many), width = 0.7) +
  theme_light() +
  coord_flip()  +
  scale_fill_brewer() +
  guides(fill=guide_legend(title="Species:")) + 
  scale_y_continuous(name = "Number of reviews",
                     breaks = seq(0, 20, by = 2)) +
  theme_light() +
  theme(legend.position = "bottom",
       legend.box.background = element_rect(colour = "black"), 
       legend.title = element_text(size = 8),  
       legend.text=element_text(size = 8), 
       axis.title.x = element_text(size = 8), 
       axis.title.y = element_blank(),
       axis.text = element_text(size = 8),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"),
       plot.title = element_text(size = 10))

# ggsave(here("R_data", "plot_species_howmany.png"),
#        width = 8,
#        height = 6)

```

### Species + PFAS

```{r PFAS and species focus one_many dotplot, height = 2, width = 8}

mdata %>% 
  count(Species_one_many, PFAS_one_many) -> t2 #make table of counts across two columns

t2$Species_one_many <- as.factor(t2$Species_one_many)

levels(t2$Species_one_many) <- c("Many", "One") #reorder levels for Species_one_many

t2 %>% 
  filter(Species_one_many != "NA") -> t2 #filter out NA

# heatmap
sp3 <- ggplot(data = t2, aes(Species_one_many, PFAS_one_many)) +
  labs(title = expression(bold(""))) +
  geom_tile(aes(fill = n)) +
  scale_fill_gradient(low = "#F3A712", high = "#E4572E") +
  xlab("Species") +
  ylab("PFAS") +
  theme_light() +
  theme(axis.text.x=element_text(angle = 90,
                                 size = 8,
                                 vjust = 0.5),
        axis.text.y=element_text(size = 8),
        axis.text = element_text(size = 8),
        plot.title = element_text(size = 10)) +
  theme(legend.position = "bottom")

sp3
```

```{r}
sp2-sp1
# ggsave(here("Figs/Suppl_Figs", "SFig1.png"),
#        width = 8,
#        height = 9)
sp3
# ggsave(here("Figs/Suppl_Figs", "SFig2.png"),
#        width = 7,
#        height = 7)
sp4
```



### Specie tree

Species tree in "species_tree.Rmd"

## Number of studies
Number of studies in each SR and review subject

```{r}
mdata_n_studies <- mdata %>% 
  filter(PFAS_focus == "Yes")

mdata_n_studies$Human_animal_environment <- fct_relevel(mdata_n_studies$Human_animal_environment, c("Humans",
                                                                                "Animals",
                                                                                "Environment", 
                                                                                "Mixed"))

n_studies_1 <- ggplot(mdata_n_studies, aes(x = Human_animal_environment, 
                  y = log10(N_studies),
                  fill = Human_animal_environment)) +
  labs(title = expression(bold("a)"))) +
  geom_violin(alpha = 0.5) +
  geom_boxplot(width=0.1, 
               outlier.shape = NA) +
  scale_fill_manual(values = cbp2,
                    guide = guide_legend(override.aes = list(size=5, linetype=0))) +
  scale_y_continuous(breaks = seq(0, 3.5, by = 0.2),
                     expand = c(0,0.1),
                     limits = c(0,3.5)) +
  labs(x = "Review subject",
       y = "log10(n)") +
  theme_classic() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  guides(fill = guide_legend(ncol = 1))

n_studies_1
```

Without systematic evidence maps

```{r, eval=FALSE}
# n_studies_2 <- ggplot(mdata_n_studies, aes(x = Human_animal_environment, 
#                   y = N_studies,
#                   fill = Human_animal_environment)) +
#   labs(title = expression(bold("a)"))) +
#   geom_violin(alpha = 0.5) +
#   geom_boxplot(width=0.1, 
#                outlier.shape = NA) +
#   scale_fill_manual(values = cbp2,
#                     guide = guide_legend(override.aes = list(size=5, linetype=0))) +
#   scale_y_continuous(breaks = seq(0, 250, by = 25),
#                      expand = c(0,1),
#                      limits = c(0,250)) +
#   labs(x = "Review subject",
#        y = "Number of studies included in SRs") +
#   theme_classic() +
#   theme(legend.position = "none",
#         legend.title = element_blank(),
#         axis.text.x = element_blank(),
#         axis.title.x = element_blank(),
#         panel.grid.major = element_line(color = "grey", 
#                                        linewidth  = 0.2, 
#                                        linetype = "dashed"),
#        panel.grid.minor = element_line(color = "grey", 
#                                       linewidth  = 0.2, 
#                                       linetype = "dotted"))
# n_studies_2
```

Number of studies in each SR and type of review

```{r}
# create a factor with the desired order of levels
order_levels <- c("systematic review",
                  "meta-analysis", 
                  "systematic review and meta-analysis", 
                  "comprehensive review",
                  "scoping review",
                  "critical review",
                  "review",
                  "systematic evidence map")

mdata_n_studies$Review_type_claimed <- factor(mdata_n_studies$Review_type_claimed, levels=order_levels)

n_studies_3 <- ggplot(mdata_n_studies, aes(x = Review_type_claimed, 
                  y = log10(N_studies),
                  fill = Review_type_claimed)) +
  labs(title = expression(bold("b)"))) +
  geom_violin(alpha = 0.5) +
  geom_boxplot(width=0.1, 
               outlier.shape = NA) +
  scale_fill_manual(values = my_palette) +
  scale_y_continuous(breaks = seq(0, 3.5, by = 0.2),
                     expand = c(0,0.1),
                     limits = c(0,3.5)) +
  labs(x = "Review type",
       y = "log10(n)") +
  theme_classic() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  guides(fill = guide_legend(ncol = 2))

n_studies_3
```

Without systematic evidence maps

```{r, eval=FALSE}
# n_studies_4 <- ggplot(mdata_n_studies, aes(x = Review_type_claimed, 
#                   y = N_studies,
#                   fill = Review_type_claimed)) +
#   labs(title = expression(bold("b)"))) +
#   geom_violin(alpha = 0.5) +
#   geom_boxplot(width=0.1, 
#                outlier.shape = NA) +
#   scale_fill_manual(values = my_palette,
#                     guide = guide_legend(override.aes = list(size=5, linetype=0))) +
#   scale_y_continuous(breaks = seq(0, 250, by = 50),
#                      expand = c(0,1),
#                      limits = c(0,250)) +
#   scale_x_discrete(limits = c(order_levels)) +
#   labs(x = "Review type",
#        y = "Number of studies included in SRs") +
#   theme_classic() +
#   theme(legend.position = "none",
#         legend.title = element_blank(),
#         axis.title.x = element_blank(),
#         axis.title.y = element_blank(),
#         axis.text.x = element_blank(),
#         panel.grid.major = element_line(color = "grey", 
#                                        linewidth  = 0.2, 
#                                        linetype = "dashed"),
#        panel.grid.minor = element_line(color = "grey", 
#                                       linewidth  = 0.2, 
#                                       linetype = "dotted")) +
#   annotate("text", x = which(order_levels == "systematic evidence map"), y = +20, label = "NA")
# 
# n_studies_4
```

Combined

```{r}
n_studies_1-n_studies_3

# ggsave(here("Figs/Suppl_Figs", "SFig15.png"),
#        width = 9,
#        height = 6)
```

# Environments

```{r}
t_enviro <- mdata %>%
  filter(Environment_type != "NA") %>% #filter out NA
  count(Environment_type) %>%
  mutate(percentage = round( n / sum(is.na(mdata$Environment_type) == FALSE) * 100))

t_enviro$Environment_type <-
  factor(t_enviro$Environment_type, levels = unique(t_enviro$Environment_type[order(t_enviro$n, decreasing = FALSE)]))

p_enviro <- ggplot(t_enviro, aes(x = Environment_type,
                                y = percentage)) +
  geom_col(aes(color = "black",
               fill = "#999999"), 
           alpha = 0.5,
          width = 0.8,
          size = 0.2) +
  theme_light() +
  labs(title = expression(bold(""))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Type of environment") +
  scale_y_continuous(name = "Percentage of reviews on the environment (%)",
                     breaks = seq(0, 80, by = 10),
                     expand = c(0,1),
                     limits = c(0,60)) +
  scale_fill_manual(values = c("#999999")) +
  scale_color_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(n), x = Environment_type), 
            position = position_stack(vjust = 0.5), 
            size = 2.7) + 
  theme(title = element_text(size = 12),
        legend.position = "none",
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        axis.text = element_text(size = 9),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
p_enviro

# ggsave(here("Figs/Suppl_Figs", "SFig16.png"),
#        width = 9,
#        height = 6)
```


# ------------------------------------------------------------------------

# Objective 2. Critical appraisal: How robust are syntheses of PFAS evidence?

Here we will examine the included syntheses for their reporting quality and potential biases, in order to assess reliability of reviews' conclusions, reveal syntheses that should be re-done, and highlight the aspects of review methodology that need to be improved.

## Table AMSTAR2 questions

The questions were stored separately in the first row of the file, and were loaded separately. We display them in a table, alongside the short labels that can be used in the plots. Full description of the questions and coding rules (from an adapted AMSTAR2 checklist; Shea et al. 2017; Samarasinghe et al. 2019), are provided in the protocol.

```{r AMSTAR2 questions}
questions_list <- qdata %>% 
  select(starts_with("Q") & !ends_with("_comment")) %>% 
  colnames()  #only select columns with assessment codes (data)

questions <- tibble(questions = questions_list, label = c("question and criteria", "a priori protocol", "included study designs", "comprehensive search", "selection duplicated", "extraction duplicated", "list of excluded studies", "summary of included studies", "critical appraisal", "sources of funding", "quantitative synthesis", "risk of bias", "effect of bias", "variability investigated", "publication bias", "conflict of interest"))
#str(questions)

knitr::kable(questions, caption = "Table. List of AMSTAR2 questions with labels for plotting") %>%
  kable_paper(bootstrap_options = "striped", full_width = F)

# save_as_docx("my table 1" = questions,
#              path = "R_data/questions.docx")
```

## Summary plot Questions

AMSTAR2 assessment results as percentages of each answer score per questiontakes the data from the .

```{r plot AMSTAR2 summary}
## prepare data 
dim(qdata) #some empty rows to be removed

#studies <- qdata$Author_year #normally would use this

#only select columns with assessment codes (drop comments and empty rows)
qtable <- 
  qdata %>%
  select(starts_with("Q") & !ends_with("_Comment"))  

#simiplify column names to Q+number format
names(qtable) <- 
  gsub("\\..*", "", names(qtable)) 

#simplify all the answers to short strings (version for a single column: gsub(" =.*", "", qtable$Q1)):
qtable <- 
  apply(qtable, 2, function(y) as.character(gsub(" =.*", "", y)))

#save studies in a new vector
studies <- 
  qdata$Study_ID[!is.na(qdata$Study_ID)]

#convert to long format data frame with Study_ID
qtable_long <-
  data.frame(study = studies,
             question = rep(colnames(qtable),each = length(studies)),
             score = as.vector(qtable), stringsAsFactors = TRUE) #make long format table

rownames(qtable_long) <- NULL
qtable_long$question <- 
  factor(qtable_long$question, levels(qtable_long$question)[rev(c(1,9:16,2:8))]) #setting the order of levels - by Q-number

#add a column with verbal expression of scores:   
qtable_long <- qtable_long %>% 
  mutate(score_word = case_when(
    score == "1" ~ "Yes",
    score == "0.5" ~ "Partially",
    score == "0" ~ "No",
    score == "N/A" ~ "NA",
    TRUE ~ as.character(score)
  ))

levels(qtable_long$score_word) <- c("No",
                               "Partially",
                               "Yes", 
                               "NA")

qtable_long$score_word <- ifelse(qtable_long$score_word == "Yes", "No",
                                 ifelse(qtable_long$score_word == "No", "Yes",
                                        qtable_long$score_word))

qtable_long <- qtable_long %>% 
  mutate(label = case_when(
    question == "Q1" ~ "Q1: research question and criteria",
    question == "Q2" ~ "Q2: a priori protocol",
    question == "Q3" ~ "Q3: included studies design",
    question == "Q4" ~ "Q4: comprehensive search",
    question == "Q5" ~ "Q5: selection duplicated",
    question == "Q6" ~ "Q6: extraction duplicated",
    question == "Q7" ~ "Q7: list of excluded studies",
    question == "Q8" ~ "Q8: summary of included studies",
    question == "Q9" ~ "Q9: critical appraisal",
    question == "Q10" ~ "Q10: included studies' funding",
    question == "Q11" ~ "Q11: appropriate meta-analysis",
    question == "Q12" ~ "Q12: evaluation of the RoB impacts",
    question == "Q13" ~ "Q13: RoB in individual studies",
    question == "Q14" ~ "Q14: variability investigation",
    question == "Q15" ~ "Q15: publication bias",
    question == "Q16" ~ "Q16: conflict of interest"
  ))

qtable_long$label <-
  factor(qtable_long$label, levels = unique(qtable_long$label[order(qtable_long$question, decreasing = FALSE)]))

summaryplot <-
  ggplot(data = qtable_long) +
  labs(title = expression(bold(""))) +
  geom_bar(mapping = aes(x = label, 
                         fill = fct_relevel(score_word, c("NA", "Yes",
                               "Partially",
                               "No"))),
           alpha = 1,
           width = 0.8,
           size = 0.2, 
           position = "fill",
           color = "black") + 
  coord_flip(ylim = c(0, 1)) +
  guides(fill = guide_legend(reverse = F)) +
  scale_fill_manual("Risk of Bias:",
                    values = cbp4,
                    breaks = c("No",
                               "Partially",
                               "Yes",
                               "NA")) +
  scale_y_continuous(name = "Proportion",
                     labels = scales::percent, 
                     expand = c(0.02,0)) +
  scale_x_discrete(name = "AMSTAR2 Question",
                   expand = c(0,0)) +
  theme(axis.title.x = element_text(size = 11),
            axis.title.y = element_text(size = 11),
            axis.ticks.y = element_blank(),
            axis.text.x = element_text(size = 9, 
                                       color = "black",
                                       hjust = 0.5),
            axis.text.y = element_text(size = 9, 
                                       color = "black",
                                       vjust = 0.5 ),
            axis.line.x = element_line(linewidth = 0.5,
                                       colour = "black", 
                                       linetype = "solid"),
            legend.position = "bottom",
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            legend.background = element_rect(linetype = "solid", 
                                             colour = "black",
                                             size = 0.2),
            legend.title = element_text(size = 10),
            legend.key.size = unit(0.5, "cm"),
            legend.text = element_text(size = 9))

# display plot
summaryplot

#save the plot
# ggsave(here("Figs","Fig5.png"),
#        width = 7,
#        height = 5)

```

### Subject

HUMANS

```{r}
#save studies in a new vector
subject <- 
  mqdata$Human_animal_environment[!is.na(mqdata$Human_animal_environment)]

#convert to long format data frame with Study_ID
qtable_long_sub <-
  data.frame(study = studies,
             subject = subject,
             question = rep(colnames(qtable),each = length(studies)),
             score = as.vector(qtable), stringsAsFactors = TRUE) #make long format table

rownames(qtable_long_sub) <- NULL
qtable_long_sub$question <- 
  factor(qtable_long_sub$question, levels(qtable_long_sub$question)[rev(c(1,9:16,2:8))]) #setting the order of levels - by Q-number

#add a column with verbal expression of scores:   
qtable_long_sub <- qtable_long_sub %>% 
  mutate(score_word = case_when(
    score == "1" ~ "Yes",
    score == "0.5" ~ "Partially",
    score == "0" ~ "No",
    score == "N/A" ~ "NA",
    TRUE ~ as.character(score)
  ))

qtable_long_sub_hum <- qtable_long_sub %>% 
  filter(subject == "Humans") 

levels(qtable_long_sub_hum$score_word) <- c("No",
                               "Partially",
                               "Yes", 
                               "NA")

summaryplot_hum <-
  ggplot(data = qtable_long_sub_hum) +
  labs(title = expression(bold("a) Humans"))) +
  geom_bar(mapping = aes(x = question, 
                         fill = score_word),
           width = 0.7, 
           position = "fill",
           color = "black") +
  coord_flip(ylim = c(0, 1)) +
  guides(fill = guide_legend(reverse = F)) +
  scale_fill_manual("Risk of Bias",
                    values = cbp4,
                    breaks = c("Yes",
                               "Partially",
                               "No",
                               "NA")) +
  scale_y_continuous(name = "Proportion",
                     labels = scales::percent, 
                     expand = c(0.02,0)) +
  scale_x_discrete(name = "AMSTAR2 Question",
                   expand = c(0.02,0)) +
  theme(axis.title.x = element_blank(),
            axis.title.y = element_text(size = 11),
            axis.ticks.y = element_blank(),
            axis.text.x = element_text(size = 10, 
                                       color = "black",
                                       hjust = 0.5),
            axis.text.y = element_text(size = 10, 
                                       color = "black",
                                       vjust = 0.5 ),
            axis.line.x = element_line(linewidth = 0.5,
                                       colour = "black", 
                                       linetype = "solid"),
            legend.position = "none",
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            legend.background = element_rect(linetype = "solid", 
                                             colour = "black",
                                             size = 0.2),
            legend.title = element_blank(),
            legend.key.size = unit(0.5, "cm"),
            legend.text = element_text(size = 10))

summaryplot_hum
```

ANIMALS

```{r}
qtable_long_sub_anim <- qtable_long_sub %>% 
  filter(subject == "Animals") 

levels(qtable_long_sub_anim$score_word) <- c("No",
                               "Partially",
                               "Yes", 
                               "NA")

summaryplot_anim <-
  ggplot(data = qtable_long_sub_anim) +
  labs(title = expression(bold("b) Animals"))) +
  geom_bar(mapping = aes(x = question, 
                         fill = score_word),
           width = 0.7, 
           position = "fill",
           color = "black") +
  coord_flip(ylim = c(0, 1)) +
  guides(fill = guide_legend(reverse = F)) +
  scale_fill_manual("Risk of Bias",
                    values = cbp4,
                    breaks = c("Yes",
                               "Partially",
                               "No",
                               "NA")) +
  scale_y_continuous(name = "Proportion",
                     labels = scales::percent, 
                     expand = c(0.02,0)) +
  scale_x_discrete(name = "AMSTAR2 Question",
                   expand = c(0.02,0)) +
  theme(axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.text.x = element_text(size = 10, 
                                       color = "black",
                                       hjust = 0.5),
            axis.text.y = element_text(size = 10, 
                                       color = "black",
                                       vjust = 0.5 ),
            axis.line.x = element_line(linewidth = 0.5,
                                       colour = "black", 
                                       linetype = "solid"),
            legend.position = "none",
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            legend.background = element_rect(linetype = "solid", 
                                             colour = "black",
                                             size = 0.2),
            legend.title = element_blank(),
            legend.key.size = unit(0.5, "cm"),
            legend.text = element_text(size = 10))

summaryplot_anim
```

ENVIRONMENT

```{r}
qtable_long_sub_env <- qtable_long_sub %>% 
  filter(subject == "Environment") 

levels(qtable_long_sub_env$score_word) <- c("No",
                               "Partially",
                               "Yes", 
                               "NA")

summaryplot_env <-
  ggplot(data = qtable_long_sub_env) +
  labs(title = expression(bold("c) Environment"))) +
  geom_bar(mapping = aes(x = question, 
                         fill = score_word),
           width = 0.7, 
           position = "fill",
           color = "black") +
  coord_flip(ylim = c(0, 1)) +
  guides(fill = guide_legend(reverse = F)) +
  scale_fill_manual("Risk of Bias",
                    values = cbp4,
                    breaks = c("Yes",
                               "Partially",
                               "No",
                               "NA")) +
  scale_y_continuous(name = "Proportion",
                     labels = scales::percent, 
                     expand = c(0.02,0)) +
  scale_x_discrete(name = "AMSTAR2 Question",
                   expand = c(0.02,0)) +
  theme(axis.title.x = element_text(size = 11),
            axis.title.y = element_text(size = 11),
            axis.ticks.y = element_blank(),
            axis.text.x = element_text(size = 10, 
                                       color = "black",
                                       hjust = 0.5),
            axis.text.y = element_text(size = 10, 
                                       color = "black",
                                       vjust = 0.5 ),
            axis.line.x = element_line(linewidth = 0.5,
                                       colour = "black", 
                                       linetype = "solid"),
            legend.position = "none",
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            legend.background = element_rect(linetype = "solid", 
                                             colour = "black",
                                             size = 0.2),
            legend.title = element_blank(),
            legend.key.size = unit(0.5, "cm"),
            legend.text = element_text(size = 10))

summaryplot_env
```

MIXED

```{r}
qtable_long_sub_mix <- qtable_long_sub %>% 
  filter(subject == "Mixed") 

levels(qtable_long_sub_mix$score_word) <- c("No",
                               "Partially",
                               "Yes", 
                               "NA")

summaryplot_mix <-
  ggplot(data = qtable_long_sub_mix) +
  labs(title = expression(bold("d) Multiple subjects"))) +
  geom_bar(mapping = aes(x = question, 
                         fill = score_word),
           width = 0.7, 
           position = "fill",
           color = "black") +
  coord_flip(ylim = c(0, 1)) +
  guides(fill = guide_legend(reverse = F)) +
  scale_fill_manual("Risk of Bias",
                    values = cbp4,
                    breaks = c("Yes",
                               "Partially",
                               "No",
                               "NA")) +
  scale_y_continuous(name = "Proportion",
                     labels = scales::percent, 
                     expand = c(0.02,0)) +
  scale_x_discrete(name = "AMSTAR2 Question",
                   expand = c(0.02,0)) +
  theme(axis.title.x = element_text(size = 11),
            axis.title.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.text.x = element_text(size = 10, 
                                       color = "black",
                                       hjust = 0.5),
            axis.text.y = element_text(size = 10, 
                                       color = "black",
                                       vjust = 0.5 ),
            axis.line.x = element_line(linewidth = 0.5,
                                       colour = "black", 
                                       linetype = "solid"),
            legend.position = "none",
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            legend.background = element_rect(linetype = "solid", 
                                             colour = "black",
                                             size = 0.2),
            legend.title = element_blank(),
            legend.key.size = unit(0.5, "cm"),
            legend.text = element_text(size = 10))

summaryplot_mix
```

###COMBINED

```{r}
(summaryplot_hum - summaryplot_anim)/(summaryplot_env - summaryplot_mix)
# save plot
# ggsave(here("Figs/Suppl_Figs","SFig4.png"),
#        width = 9,
#        height = 9)
```

###Systematic VS non-systematic

Systematic approach
```{r}
#save studies in a new vector
system_approach <- 
  mqdata$Systematic_approach[!is.na(mqdata$Systematic_approach)]

#convert to long format data frame with Study_ID
qtable_long_syst <-
  data.frame(study = studies,
             systematic_approach = system_approach,
             question = rep(colnames(qtable),
                            each = length(studies)),
             score = as.vector(qtable),
             stringsAsFactors = TRUE) #make long format table

rownames(qtable_long_syst) <- NULL
qtable_long_syst$question <- 
  factor(qtable_long_syst$question, levels(qtable_long_syst$question)[rev(c(1,9:16,2:8))]) #setting the order of levels - by Q-number

#add a column with verbal expression of scores:   
qtable_long_syst <- qtable_long_syst %>% 
  mutate(score_word = case_when(
    score == "1" ~ "Yes",
    score == "0.5" ~ "Partially",
    score == "0" ~ "No",
    score == "N/A" ~ "NA",
    TRUE ~ as.character(score)
  ))

qtable_long_syst_yes <- qtable_long_syst %>% 
  filter(systematic_approach == "Yes") 

levels(qtable_long_syst_yes$score_word) <- c("No",
                               "Partially",
                               "Yes", 
                               "NA")

summaryplot_systematic <-
  ggplot(data = qtable_long_syst_yes) +
  labs(title = expression(bold("a) Systematic approach"))) +
  geom_bar(mapping = aes(x = question, 
                         fill = score_word),
           width = 0.7, 
           position = "fill",
           color = "black") +
  coord_flip(ylim = c(0, 1)) +
  guides(fill = guide_legend(reverse = F)) +
  scale_fill_manual("Risk of Bias",
                    values = cbp4,
                    breaks = c("Yes",
                               "Partially",
                               "No",
                               "NA")) +
  scale_y_continuous(name = "Proportion",
                     labels = scales::percent, 
                     expand = c(0.02,0)) +
  scale_x_discrete(name = "AMSTAR2 Question",
                   expand = c(0.02,0)) +
  theme(axis.title.x = element_blank(),
            axis.title.y = element_text(size = 11),
            axis.ticks.y = element_blank(),
            axis.text.x = element_text(size = 8, 
                                       color = "black",
                                       hjust = 0.5),
            axis.text.y = element_text(size = 9, 
                                       color = "black",
                                       vjust = 0.5 ),
            axis.line.x = element_line(linewidth = 0.5,
                                       colour = "black", 
                                       linetype = "solid"),
            legend.position = "none",
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            legend.background = element_rect(linetype = "solid", 
                                             colour = "black",
                                             size = 0.2),
            legend.title = element_blank(),
            legend.key.size = unit(0.5, "cm"),
            legend.text = element_text(size = 10))

summaryplot_systematic
```
Non-systematic approach
```{r}
qtable_long_syst_no <- qtable_long_syst %>% 
  filter(systematic_approach == "No") 

levels(qtable_long_syst_no$score_word) <- c("No",
                               "Partially",
                               "Yes", 
                               "NA")

summaryplot_non_systematic <-
  ggplot(data = qtable_long_syst_no) +
  labs(title = expression(bold("b) Non-systematic approach"))) +
  geom_bar(mapping = aes(x = question, 
                         fill = score_word),
           width = 0.7, 
           position = "fill",
           color = "black") +
  coord_flip(ylim = c(0, 1)) +
  guides(fill = guide_legend(reverse = F)) +
  scale_fill_manual("Risk of Bias",
                    values = cbp4,
                    breaks = c("Yes",
                               "Partially",
                               "No",
                               "NA")) +
  scale_y_continuous(name = "Proportion",
                     labels = scales::percent, 
                     expand = c(0.02,0)) +
  scale_x_discrete(name = "AMSTAR2 Question",
                   expand = c(0.02,0)) +
  theme(axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.text.x = element_text(size = 9, 
                                       color = "black",
                                       hjust = 0.5),
            axis.text.y = element_text(size = 8, 
                                       color = "black",
                                       vjust = 0.5 ),
            axis.line.x = element_line(linewidth = 0.5,
                                       colour = "black", 
                                       linetype = "solid"),
            legend.position = "none",
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank(),
            legend.background = element_rect(linetype = "solid", 
                                             colour = "black",
                                             size = 0.2),
            legend.title = element_blank(),
            legend.key.size = unit(0.5, "cm"),
            legend.text = element_text(size = 10))

summaryplot_non_systematic
```

###COMBINED

```{r}
(summaryplot_systematic - summaryplot_non_systematic)
# save plot
ggsave(here("Figs/Suppl_Figs","SFig17.png"),
       width = 8,
       height = 4)
```


## Average total score by other variable

Create a table with the total score of each study
```{r, eval = FALSE}
#TODO
qtable2 <- 
  qdata %>%
  select("Study_ID" | starts_with("Q") & !ends_with("_Comment"))  

#simiplify column names to Q+number format
names(qtable2) <- 
  gsub("\\..*", "", names(qtable2)) 

#simplify all the answers to short strings (version for a single column: gsub(" =.*", "", qtable$Q1)):
qtable2 <- 
  apply(qtable2, 2, function(y) as.character(gsub(" =.*", "", y)))

# Convert the data table to a tibble
qtable2 <- as.tibble(qtable2)

# Replace all "N/A" values with 0
qtable2 <- qtable2 %>%
  mutate_all(~ifelse(.=="N/A", 0, .))

# Convert non-numeric columns to numeric
qtable2 <- qtable2 %>%
  mutate_at(vars(-Study_ID), as.numeric)

#add a column with the total score for each study:   
qtable2 <- qtable2 %>%
  mutate(total_score = rowSums(across(-1)))

# Remove columns Q1 to Q4
qtable2 <- as.data.table(qtable2)
cols_to_remove <- grep("^Q\\d+$", names(qtable2), value = TRUE)
qtable2[, (cols_to_remove) := NULL]
```

### Subject

SRs without a meta-analysis

```{r, eval = FALSE}
mscoresdata <- left_join(mdata, qtable2, by = "Study_ID")

score_subject <- mscoresdata %>%
  filter(Human_animal_environment != "NA") %>% #filter out NA
  filter(Meta_analysis == "No") %>% 
  group_by(Human_animal_environment) %>% 
  summarise(average_score = mean(total_score)) %>% 
  ungroup()

score_subject$Human_animal_environment <-
  factor(score_subject$Human_animal_environment, levels = unique(score_subject$Human_animal_environment[order(score_subject$average_score, decreasing = FALSE)]))

p_score1 <- ggplot(score_subject, aes(x = Human_animal_environment,
                                y = average_score)) +
  geom_col(aes(fill = ""), width = 0.7) +
  theme_light() +
  labs(title = expression(bold("a)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Review subject") +
  scale_y_continuous(name = "Average AMSTAR2 score",
                     breaks = seq(0, 10, by = 1)) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round(average_score)), x = Human_animal_environment),
            position = position_stack(vjust = 0.5),
            size = 2) +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
p_score1
```

SRs with a meta-analysis

```{r, eval = FALSE}
score_subject2 <- mscoresdata %>%
  filter(Human_animal_environment != "NA") %>% #filter out NA
  filter(Meta_analysis == "Yes") %>% 
  group_by(Human_animal_environment) %>% 
  summarise(average_score = mean(total_score)) %>% 
  ungroup()

score_subject2$Human_animal_environment <-
  factor(score_subject2$Human_animal_environment, levels = unique(score_subject2$Human_animal_environment[order(score_subject2$average_score, decreasing = FALSE)]))

p_score1.2 <- ggplot(score_subject2, aes(x = Human_animal_environment,
                                y = average_score)) +
  geom_col(aes(fill = ""), width = 0.7) +
  theme_light() +
  labs(title = expression(bold("b)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Review subject") +
  scale_y_continuous(name = "Average AMSTAR2 score",
                     breaks = seq(0, 10, by = 1)) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round(average_score)), x = Human_animal_environment),
            position = position_stack(vjust = 0.5),
            size = 2) +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
```

### Country first author

```{r, eval = FALSE}
score_country <- mscoresdata %>%
  filter(Country_firstAuthor != "NA") %>%
  filter(Meta_analysis == "No") %>% 
  group_by(Country_firstAuthor) %>% 
  summarise(average_score = mean(total_score)) %>% 
  ungroup()

score_country$Country_firstAuthor <-
  factor(score_country$Country_firstAuthor, levels = unique(score_country$Country_firstAuthor[order(score_country$average_score, decreasing = FALSE)]))

ggplot(score_country, aes(x = Country_firstAuthor,
                                y = average_score)) +
  geom_col(aes(fill = ""), width = 0.7) +
  theme_light() +
  labs(title = expression(bold("a)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Country of first author") +
  scale_y_continuous(name = "Average AMSTAR2 score",
                     breaks = seq(0, 16, by = 1),
                     expand = c(0,0)) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round(average_score)), x = Country_firstAuthor),
            position = position_stack(vjust = 0.5),
            size = 2) +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
```


### Journal

```{r, eval = FALSE}
score_journal <- mscoresdata %>%
  filter(Journal != "NA") %>% 
  filter(Meta_analysis == "No") %>% 
  group_by(Journal) %>% 
  summarise(average_score = mean(total_score)) %>% 
  ungroup()

score_journal$Journal <-
  factor(score_journal$Journal, levels = unique(score_journal$Journal[order(score_journal$average_score, decreasing = FALSE)]))

ggplot(score_journal, aes(x = Journal,
                          y = average_score)) +
  geom_col(aes(fill = ""), width = 0.7) +
  theme_light() +
  labs(title = expression(bold("a)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Journal") +
  scale_y_continuous(name = "Average AMSTAR2 score",
                     breaks = seq(0, 16, by = 1),
                     expand = c(0,0)
                     ) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round(average_score)), x = Journal),
            position = position_stack(vjust = 0.5),
            size = 2) +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 8),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
```

### Review type

```{r, eval = FALSE}
score_type <- mscoresdata %>%
  filter(Review_type_claimed != "NA") %>%
  filter(Meta_analysis == "No") %>% 
  group_by(Review_type_claimed) %>% 
  summarise(average_score = mean(total_score)) %>% 
  ungroup()

score_type$Review_type_claimed <-
  factor(score_type$Review_type_claimed, levels = unique(score_type$Review_type_claimed[order(score_type$average_score, decreasing = FALSE)]))

ggplot(score_type, aes(x = Review_type_claimed,
                          y = average_score)) +
  geom_col(aes(fill = ""), width = 0.7) +
  theme_light() +
  labs(title = expression(bold("a)"))) + #~bold(A.)~' Type and subject'
  coord_flip()+
  scale_x_discrete(name = "Review type claimed") +
  scale_y_continuous(name = "Average AMSTAR2 score",
                     breaks = seq(0, 16, by = 1),
                     expand = c(0,0)
                     ) +
  scale_fill_manual(values = c("#999999")) +
  geom_text(aes(label = paste0(round(average_score)), x = Review_type_claimed),
            position = position_stack(vjust = 0.5),
            size = 2) +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 8),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
```


## Individual scores plot

AMSTAR2 assessment results as a score per article per question.

```{r AMSTAR2 scores}
## data prep
dim(qdata) #some empty rows to be removed

#save studies in a new vector
studies <- qdata$Study_ID[!is.na(qdata$Study_ID)]
#studies <- qdata$Author_year #normally would use this

#only select columns with assessment codes (drop comments and empty rows)
qtable <- qdata %>%
  filter(Study_ID!="NA") %>%
  select(starts_with("Q") & !ends_with("_comment")) 

#simiplify column names to Q+number format
names(qtable) <- gsub("\\..*", "", names(qtable)) 

#simplify all the answers to short strings (version for a single column: gsub(" =.*", "", qtable$Q1)):
qtable <- apply(qtable, 2, function(y) as.character(gsub(" =.*", "", y)))

## prepare data - change scores to verbal expressions: 
qtable <- gsub("N/A", "Not Applicable", qtable)
qtable <- gsub("0.5", "Partially", qtable)
qtable <- gsub("1", "Yes", qtable)
qtable <- gsub("0", "No", qtable)


#convert to long format data frame with Study_ID
qtable_long <- data.frame(study = as.factor(studies),
                     question = rep(colnames(qtable), 
                                    each = length(studies)),
                     measurement = as.vector(qtable), 
                     stringsAsFactors=FALSE)

rownames(qtable_long) = NULL

qtable_long$question <- as.factor(qtable_long$question)

qtable_long$question <- factor(qtable_long$question, levels(qtable_long$question)[c(1,9:16,2:8)]) #setting the order of levels - by Q-number

qtable_long$study <- factor(qtable_long$study, levels = unique(studies)[order(as.numeric(gsub("S_","", unique(qtable_long$study))))]) #Re-order by study ID (from S_001 to S_175)

qtable_long$measurement <- ifelse(qtable_long$measurement == "Yes", "No",
                                 ifelse(qtable_long$measurement == "No", "Yes",
                                        qtable_long$measurement))

##Make scoreplot      
scoresplot <-
  ggplot(data = qtable_long, aes(y = study,
                                 x = question)) +
  geom_tile(color = "black",
            fill = "white", 
            size = 0.3) +
  geom_point(aes(color = as.factor(fct_relevel(measurement, c("No",
                               "Partially",
                               "Yes",
                               "Not Applicable")))), 
             size = 1) +
  #geom_text(aes(label = measurement), size = 8) +
  scale_color_manual("Risk of Bias:",
                     values = cbp4,
                     c("No",
                               "Partially",
                               "Yes",
                               "Not Applicable"),
                     guide = guide_legend(override.aes = list(size = 3,
                                                              alpha = 1))) +
  theme_minimal() +
  coord_equal() +
  theme_light() +
  theme(axis.title.x = element_text(size = 7, 
                                    color = "black", 
                                    face = "italic"),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 7,
                                   color = "black"),
        axis.text.x = element_text(size = 6, 
                                   color = "black",
                                   angle = 90,
                                   hjust = 0,
                                   vjust = 0.6
                                   ),
        legend.position = "bottom",
        legend.background = element_rect(linetype = "solid", 
                                         colour = "black",
                                         size = 0.2
                                         ),
        legend.title = element_text(size = 9),
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 9),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()
              #plot.margin = unit(c(1,1,1,0), "cm") #set margins for saving into pdf file
              ) +
  coord_flip()
  
scoresplot
  
# save plot
# ggsave(here("Figs/Suppl_Figs","SFig5.png"),
#        width = 12,
#        height = 6,
#        angle = 90)
```

## Summary table total scores
```{r}
study_score <- qtable_long %>%
  group_by(study) %>%
  mutate(score = ifelse(score_word == "Yes", 1, ifelse(score_word == "Partially", 0.5, ifelse(score_word == "No", 0, 0)))) %>%
  summarize(total_score = sum(score))

#Make the table
knitr::kable(select(study_score,
                    study,
                    total_score), 
             caption = "Total score of each included review") %>%
  kable_paper(bootstrap_options = "striped", full_width = F) #%>% 
 #save_kable(here("R_data", "table1.html"), self_contained = T)
study_score

```


```{r}
qtable_long %>% 
  filter(question == "Q1") %>% 
  summarize(yes_count = sum(measurement == "Yes"),
            total_count = n()) %>%
  mutate(percentage = (yes_count/total_count)*100)
#          yes_count total_count percentage
# 1        39         109   35.77982     
qtable_long %>% 
  filter(question == "Q1") %>% 
  summarize(p_count = sum(measurement == "Partially"),
            total_count = n()) %>%
  mutate(percentage = (p_count/total_count)*100)
#   p_count total_count percentage
# 1      52         109   47.70642
qtable_long %>% 
  filter(question == "Q2") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       87         109   79.81651
qtable_long %>% 
  filter(question == "Q3") %>% 
  summarize(yes_count = sum(measurement == "Yes"),
            total_count = n()) %>%
  mutate(percentage = (yes_count/total_count)*100)
#   yes_count total_count percentage
# 1        69         109   63.30275
qtable_long %>% 
  filter(question == "Q4") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       50         109   45.87156
qtable_long %>% 
  filter(question == "Q4") %>% 
  summarize(p_count = sum(measurement == "Partially"),
            total_count = n()) %>% 
  mutate(percentage = (p_count/total_count)*100)
#   p_count total_count percentage
# 1      33         109   30.27523
qtable_long %>% 
  filter(question == "Q5") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       63         109   57.79817
qtable_long %>% 
  filter(question == "Q6") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       78         109   71.55963
qtable_long %>% 
  filter(question == "Q8") %>% 
  summarize(yes_count = sum(measurement == "Yes"),
            total_count = n()) %>%
  mutate(percentage = (yes_count/total_count)*100)
#   yes_count total_count percentage
# 1        65         109   59.63303
qtable_long %>% 
  filter(question == "Q9") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       69         109   63.30275
qtable_long %>% 
  filter(question == "Q11") %>% 
  filter(measurement != "Not Applicable") %>% 
  summarize(no_count = sum(measurement == "Yes"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       32          37   86.48649
qtable_long %>% 
  filter(question == "Q12") %>% 
  filter(measurement != "Not Applicable") %>% 
  summarize(no_count = sum(measurement == "Yes"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       12          36   33.33333
qtable_long %>% 
  filter(question == "Q13") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       84         109   77.06422
qtable_long %>% 
  filter(question == "Q14") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       79         109   72.47706
qtable_long %>% 
  filter(question == "Q15") %>% 
  filter(measurement != "Not Applicable") %>% 
  summarize(no_count = sum(measurement == "No"),
            total_count = n()) %>% 
  mutate(percentage = (no_count/total_count)*100)
#   no_count total_count percentage
# 1       18          39   46.15385
qtable_long %>% 
  filter(question == "Q16") %>% 
  summarize(yes_count = sum(measurement == "Yes"),
            total_count = n()) %>% 
  mutate(percentage = (yes_count/total_count)*100)
#   yes_count total_count percentage
# 1        87         109   79.81651
```

```{r plot combine AMSTAR2, eval = FALSE, include = FALSE}
#Make a figure with two plots in one column and save to a pdf file

## combine plots
finalplot <- summaryplot + scoresplot + plot_layout(ncol = 1)
finalplot
## save combined figure
#ggsave(here("plots","figure_AMSTAR2_2plots_v01.pdf"), width = 10, height = 16, units = "cm", scale = 2, device = cairo_pdf)

```

## COI statement

Whether Conflict Of Interests statement is provided for individual reviews.

```{r COI_statement barplot, height = 2, width = 8}

t_COI_statement <-
  mdata %>%
  count(COI_statement) %>%
  arrange(desc(n)) %>%
  filter(COI_statement != "NA") %>%  #filter out NA
  mutate(percentage = round( n / sum(n) * 100))

p1 <-
  ggplot(t_COI_statement, aes(x = COI_statement,
                              y = percentage)) +
  geom_col(aes(fill = fct_relevel(COI_statement,
                                  c("Yes", "No")),
                                  width = 0.7)) +
  scale_fill_manual(values = c("#588157", "#DE6449"),
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Percentage of reviews (%)",
                     breaks = seq(0, 90, by = 20)) +
  scale_x_discrete(name = "COI statement provided") +
  coord_flip() +
  geom_text(aes(label = paste0(n), x = COI_statement), 
            position = position_stack(vjust = 0.5), 
            size = 2) + 
  ggtitle(expression(bold("a)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
  
p1

```

## COI present

Whether potential Conflict Of Interests is acknowledged for individual reviews.

```{r COI_present barplot, height = 2, width = 8}

t_COI_present <- 
  mdata %>% 
  count(COI_present) %>% 
  arrange(desc(n)) %>% 
  filter(COI_present != "NA") %>% #filter out NA
  mutate(percentage = round( n / sum(n) * 100))

p2 <- 
  ggplot(t_COI_present, aes(x = COI_present,
                            y = percentage)) +
  geom_col(aes(fill = fct_relevel(COI_present,
                                  c("No", "Yes")),
               width = 0.7)) + 
  scale_fill_manual(values = c("#588157", "#DE6449"),
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Percentage of reviews (%)",
                     breaks = seq(0, 90, by = 20)) +
  scale_x_discrete(name = "COI present") +
  coord_flip() +
  geom_text(aes(label = paste0(n), x = COI_present), 
            position = position_stack(vjust = 0.5),
            size = 2) +
  ggtitle(expression(bold("b)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
p2
```

## Funding statement

Whether funding statement is provided for individual reviews.

```{r Funding_statement barplot, height = 2, width = 8}

t_Funding_statement <- mdata %>% 
  count(Funding_statement) %>% 
  arrange(desc(n)) %>% 
  filter(Funding_statement != "NA") %>% #filter out NA
  mutate(percentage = round( n / sum(n) * 100))

p3 <- 
  ggplot(t_Funding_statement, aes(x = Funding_statement, 
                                  y = percentage)) +
  geom_col(aes(fill = fct_relevel(Funding_statement,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = c("#588157", "#DE6449"),
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Percentage of reviews (%)",
                     breaks = seq(0, 90, by = 20)) +
  scale_x_discrete(name = "Funding statement provided") +
  theme(legend.position = "none", 
        axis.title.y = element_blank()) +
  coord_flip() +
  geom_text(aes(label = paste0(n), x = Funding_statement), 
            position = position_stack(vjust = 0.5), 
            size = 2) +
  ggtitle(expression(bold("c)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p3
```

### Non-profit funding acknowledged

Whether funding from non-profit (NGO, government, universities, etc.) is acknowledged for individual reviews.

```{r t_Nonprofit_funding barplot, height = 2, width = 8}

t_no_profit <- 
  mdata %>% 
  count(No_profit_funding) %>% 
  arrange(desc(n)) %>% 
  filter(No_profit_funding != "NA") %>% #filter out NA
  mutate(percentage = round( n / sum(n) * 100))

p4 <- 
  ggplot(t_no_profit, aes(x = No_profit_funding,
                                  y = percentage)) +
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  geom_col(aes(fill = fct_relevel(No_profit_funding,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = c("#588157", "#DE6449"),
                    breaks = c("Yes", "No")) + 
  scale_y_continuous(name = "Percentage of reviews (%)",
                     breaks = seq(0, 90, by = 20)) +
  scale_x_discrete(name = "No-profit fundings") +
  coord_flip() +
  geom_text(aes(label = paste0(n), x = No_profit_funding), 
            position = position_stack(vjust = 0.5),
            size = 2) +
  ggtitle(expression(bold("d)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p4

```

### Industry funding acknowledged

Whether funding from industry (including government-industry collaborations) is acknowledged for individual reviews.

```{r Industry_funding barplot, height = 2, width = 8}

t_Funding_industry <- mdata %>% 
  count(Industry_funding) %>% 
  arrange(desc(n)) %>% 
  filter(Industry_funding != "NA") %>%  #filter out NA
  mutate(percentage = round( n / sum(n) * 100))

p5 <- 
  ggplot(t_Funding_industry, aes(x = Industry_funding,
                                 y = percentage)) +
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  geom_col(aes(fill = fct_relevel(Industry_funding,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = c("#588157", "#DE6449"),
                    breaks = c("Yes", "No")) + 
  scale_y_continuous(name = "Percentage of reviews (%)",
                     breaks = seq(0, 90, by = 20)) +
  scale_x_discrete(name = "For-profit fundings") +
  coord_flip() +
  geom_text(aes(label = paste0(n), x = Industry_funding),
            position = position_stack(vjust = 0.5),
            size = 2) +
  ggtitle(expression(bold("e)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p5
```

## Data availability

Whether extracted data is made available for individual reviews.

```{r Raw_data barplot, height = 2, width = 8}
#str(mdata)
t_Raw_data <- 
  mdata %>% 
  count(Raw_data) %>% 
  arrange(desc(n)) %>% 
  filter(Raw_data != "NA") %>% #filter out NA
  mutate(percentage = round( n / sum(n) * 100))

p6 <- ggplot(t_Raw_data, aes(x = Raw_data, 
                             y = percentage)) +
  theme(legend.position = "none",
       axis.title.y = element_blank()) +
  geom_col(aes(fill = fct_relevel(Raw_data,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = c("#588157", "#DE6449"),
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Percentage of reviews (%)",
                     breaks = seq(0, 90, by = 20)) +
  scale_x_discrete(name = "Raw data available") +
  coord_flip() +
  geom_text(aes(label = paste0(n), x = Raw_data),
            position = position_stack(vjust = 0.5),
            size = 2) +
  ggtitle(expression(bold("f)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

p6

#ggsave(here("plots","figure_data_availability.pdf"), width = 4, height = 3, units = "cm", scale = 2, device = cairo_pdf)

```

## Code availability

Whether code for analyses is made available for individual reviews.

```{r Analysis_code barplot, height = 2, width = 8}

t_Analysis_code <- 
  mdata %>% 
  count(Analysis_code) %>% 
  arrange(desc(n)) %>% 
  filter(Analysis_code != "NA") %>% #filter out NA
  mutate(percentage = round( n / sum(n) * 100))

p7 <- ggplot(t_Analysis_code, aes(x = Analysis_code, 
                                  y = percentage)) +
  theme(legend.position = "none",
       axis.title.y = element_blank()) +
  geom_col(aes(fill = fct_relevel(Analysis_code,
                                  c("Yes", "No")), width = 0.7)) + 
  scale_fill_manual(values = c("#588157", "#DE6449"),
                    breaks = c("Yes", "No")) +
  scale_y_continuous(name = "Percentage of reviews (%)",
                     breaks = seq(0, 90, by = 20)) +
  scale_x_discrete(name = "Analysis code available") +
  theme_light() +
  coord_flip() +
  geom_text(aes(label = paste0(n), x = Analysis_code),
            position = position_stack(vjust = 0.5), 
            size = 2) +
  ggtitle(expression(bold("g)"))) +
  theme_light() +
  theme(title = element_text(size = 9),
        legend.position = "none",
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text = element_text(size = 6),
        panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))
  
p7
```

## COMBINED

Plots combined - COI

```{r, plots combined 1}
pp1 <- (p1+p2)
# ggsave(here("R_data", "plots_COI.png"),
#        width = 8,
#        height = 6)
```

Plots combined - Funding

```{r, plots combined 2}
pp2 <- (p3)/(p4+p5)
# ggsave(here("R_data", "plots_fundings.png"),
#        width = 8,
#        height = 6)
```

Plots combined - Data and Code availability

```{r, plots combined 3}
pp3 <- (p6+p7)
# ggsave(here("R_data", "plots_data&code.png"),
#        width = 8,
#        height = 6)
```

Combined plots combined

```{r}
pp1+pp2+pp3
# ggsave(here("Figs/Suppl_Figs", "SFig6.png"),
#        width = 8,
#        height = 6)
```

## Time-trends
### Reporting guidelines

```{r}
rep_guideline <- mdata %>% 
  group_by(Reporting_guideline) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_guideline <-  rep_guideline %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Reporting_guideline, -cumulative))) +
  labs(title = expression(bold("a)"))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = Reporting_guideline),
             size = 2, 
             shape = 19, 
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 120, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_manual(values = c("Yes" = "#588157",
                                "No" = "#DE6449")) +
  theme_light() + 
  theme(plot.title = element_text(size = 12),
        legend.title = element_text(size = 11),
       legend.text = element_text(size = 11),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 10,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 10),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Reporting guideline")

t_guideline
# ggsave(here("R_data", "time_trend_guideline.png"),
#        width = 8,
#        height = 6)
```


### COI statement

```{r}
coi_statement <- mdata %>% 
  group_by(COI_statement) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_coi <-  coi_statement %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(COI_statement, -cumulative))) +
  labs(title = expression(bold("b)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = COI_statement),
             size = 2,
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 150, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_manual(values = c("Yes" = "#588157",
                                "No" = "#DE6449")) +
  theme_light() + 
  theme(plot.title = element_text(size = 12),
        legend.title = element_text(size = 11),
       legend.text = element_text(size = 11),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 9,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 10,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 10),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "COI statement")

t_coi
# ggsave(here("R_data", "time_trend_coi_statement.png"),
#        width = 8,
#        height = 6)
```

### COI present

```{r}
coi_present <- mdata %>% 
  group_by(COI_present) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))
  
coi_present$COI_present[is.na(coi_present$COI_present)] <- "NP"

t_coi2 <-  coi_present %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(COI_present, -cumulative))) +
  labs(title = expression(bold("c)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = COI_present), 
             size = 2, 
             shape = 19, 
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 150, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_manual(values = c("Yes" = "#588157",
                                "No" = "#DE6449",
                                "NP" = "#B8B8B8")) +
  theme_light() +
  theme(plot.title = element_text(size = 12),
        legend.title = element_text(size = 11),
       legend.text = element_text(size = 11),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 9,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 10,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "COI present")

t_coi2
# ggsave(here("R_data", "time_trend_coi_statement.png"),
#        width = 8,
#        height = 6)
```

### Funding statement

```{r}
funding_statement <- mdata %>% 
  group_by(Funding_statement) %>% 
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

t_funding <-  funding_statement %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Funding_statement, -cumulative))) +
  labs(title = expression(bold("d)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = Funding_statement),
             size = 2, 
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of SRs",
                    breaks = seq(0, 150, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_manual(values = c("Yes" = "#588157",
                                "No" = "#DE6449")) +
  theme_light() +
  theme(plot.title = element_text(size = 12),
        legend.title = element_text(size = 11),
       legend.text = element_text(size = 11),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 9,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 10,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 10),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Funding statement")

t_funding
# ggsave(here("R_data", "time_trend_funding_statement.png"),
#        width = 8,
#        height = 6)
```

### Type of funding

```{r}
funding1 <- mdata %>% 
  filter(No_profit_funding == "Yes") %>% 
  group_by(No_profit_funding) %>%
  count(Publication_year) %>% 
  mutate(cumulative1 = cumsum(n))

funding2 <- mdata %>% 
  filter(Industry_funding == "Yes") %>% 
  group_by(Industry_funding) %>%
  mutate(For_profit_funding = Industry_funding) %>% 
  select(-Industry_funding) %>% 
  count(Publication_year) %>% 
  mutate(cumulative2 = cumsum(n))

df <- rbind(funding1, funding2)

df$type <- ifelse(is.na(df$No_profit_funding), "For_profit_funding", "No_profit_funding")

df$cumulative <- ifelse(is.na(df$cumulative1), df$cumulative2, df$cumulative1)
  


t_funding2 <-  df %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(type, -cumulative))) +
  labs(title = expression(bold("e)"))) +
  geom_line(size = 0.4) + 
  geom_point(aes(color = type),
             size = 2, 
             shape = 19,
             fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of reviews",
                    breaks = seq(0, 120, by = 10),
                    minor_breaks = NULL
                    ) +
  scale_color_manual(values = c("No_profit_funding" = "#028090",
                                "For_profit_funding" = "#D17A22")) +
  theme_light() +
  theme(plot.title = element_text(size = 12),
        legend.title = element_text(size = 11),
       legend.text = element_text(size = 11),
       legend.key.size = unit(0.3, "cm"),
       axis.text.x = element_text(size = 9,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 10,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 10,
                                   hjust = 0.5),
       axis.title.y = element_blank(),
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted")) +
  labs(color = "Type of funding")

t_funding2

# ggsave(here("R_data", "time_trend_funding_type.png"),
#        width = 8,
#        height = 6)
```

### SRs AMSTAR2 average score

```{r, eval=FALSE}
# SRs without meta-analysis

score_year <- mscoresdata %>%
  filter(Publication_year != "NA") %>% #filter out NA
  filter(Meta_analysis == "No") %>% 
  group_by(Publication_year) %>% 
  summarise(average_score = mean(total_score),
            score_min = min(total_score),
            score_max = max(total_score),
            count = n_distinct(Study_ID)) %>% 
  ungroup()

score_year <- as.data.frame(score_year)

score_y_1 <- ggplot(score_year, aes(x = Publication_year, y = average_score)) +
  labs(title = expression(bold("a)"))) +
  geom_point(size = 1.5) +
  geom_errorbar(aes(ymin = score_min, ymax = score_max), 
                width = 0.2) +
  geom_smooth(method = "lm", 
              se = FALSE,
              color = "red",
              size = 0.6) +
  annotate("text",
           x = mean(range(score_year$Publication_year))-3.4, 
           y = mean(range(score_year$average_score))+7.7,
           hjust = 1.2, 
           vjust = 1.8,
           label = paste0("Corr. Coeff. = ", round(cor(score_year$Publication_year,
                                                       score_year$average_score), 2)),
           color = "red",
           size = 3) +
  geom_hline(yintercept = mean(score_year$average_score), 
             linetype = "dashed",
             color = "blue",
             size = 0.6) +
  annotate("text", 
           x = mean(range(score_year$Publication_year))-4,
           y = mean(score_year$average_score)+5.8, 
           label = paste("Average AMSTAR 2 score =", round(mean(score_year$average_score), 1)), 
           color="blue",
           size = 3) +
  geom_text(aes(label = paste0("n = ", count)), 
            hjust = -0.5, 
            vjust = -0.8,
            size = 2) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2008, 2022, by = 1),
                     minor_breaks = NULL,
                     limits = c(2011, 2022)) +
  scale_y_continuous(name = "Average AMSTAR2 score",
                    breaks = seq(0, 15, by = 1),
                    minor_breaks = NULL) +
  theme_light() +
  theme(plot.title = element_text(size = 9), 
       axis.text.x = element_text(size = 7,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 7,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_blank(),
       axis.title.y = element_text(size = 9), #add theme elements
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

# ggsave(here("R_data", "time_trend_AMSTAR2.png"),
#        width = 8,
#        height = 6)

# SRs with meta-analysis

score_year2 <- mscoresdata %>%
  filter(Publication_year != "NA") %>% #filter out NA
  filter(Meta_analysis == "Yes") %>%
  group_by(Publication_year) %>% 
  summarise(average_score = mean(total_score),
            score_min = min(total_score),
            score_max = max(total_score),
            count = n_distinct(Study_ID)) %>% 
  ungroup()

score_year2 <- as.data.frame(score_year2)

score_y_2 <- ggplot(score_year2, aes(x = Publication_year, y = average_score)) +
  labs(title = expression(bold("b)"))) +
  geom_point(size = 1.5) +
  geom_errorbar(aes(ymin = score_min, ymax = score_max),
                width = 0.2) +
  geom_smooth(method = "lm", 
              se = FALSE,
              color = "red",
              size = 0.6) +
  annotate("text",
           x = mean(range(score_year2$Publication_year))-4.4, 
           y = mean(range(score_year2$average_score))+5,
           hjust = 1.2, 
           vjust = 1.8,
           label = paste0("Corr. Coeff. = ", round(cor(score_year2$Publication_year,
                                                       score_year2$average_score), 2)),
           color = "red",
           size = 3) +
  geom_hline(yintercept = mean(score_year2$average_score), 
             linetype = "dashed",
             color = "blue",
             size = 0.6) +
  annotate("text", 
           x = mean(range(score_year2$Publication_year))-5,
           y = mean(score_year2$average_score)+4.6, 
           label = paste("Average AMSTAR 2 score =", round(mean(score_year2$average_score), 1)),
           color="blue",
           size = 3) +
  geom_text(aes(label = paste0("n = ", count)), 
            hjust = -0.5, 
            vjust = -0.8,
            size = 2) +
  scale_x_continuous(name = "Year",
                     breaks = c(2011, 2012, seq(2013, 2022, by = 1)),
                     minor_breaks = NULL,
                     limits = c(2011, 2022)) +
  scale_y_continuous(name = "Average AMSTAR2 score",
                    breaks = seq(0, 16, by = 1),
                    minor_breaks = NULL) +
  theme_light() +
  theme(plot.title = element_text(size = 9), 
       axis.text.x = element_text(size = 7,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 7,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 9),
       axis.title.y = element_text(size = 9), #add theme elements
       panel.grid.major = element_line(color = "grey", 
                                       linewidth  = 0.2, 
                                       linetype = "dashed"),
       panel.grid.minor = element_line(color = "grey", 
                                      linewidth  = 0.2, 
                                      linetype = "dotted"))

# ggsave(here("R_data", "time_trend_AMSTAR2_MAs.png"),
#        width = 8,
#        height = 6)
```

Combined
```{r} 
score_y_1/score_y_2
# ggsave(here("R_data", "time_trend_AMSTAR2_combined.png"),
#        width = 7,
#        height = 8)
```


### COMBINED

```{r}
t_guideline/(t_coi+t_coi2)/(t_funding+t_funding2)
ggsave(here("Figs", "Fig6.png"),
       width = 11,
       height = 12)
```

# ------------------------------------------------------------------------

# Objective 3. Bibliometrics: How is synthesized PFAS evidence connected?

Examine which countries and institutions are mostly involved in secondary PFAS research. Visualizing networks between these institutions.

## Basic summaries from bibliographic records

```{r basic bibliometric summaries}
results1 <- biblioAnalysis(bib_data) #run basic standard descriptive analysis of the dataset (data frame)
summary(results1, k = 10, pause = F, width = 130) #produces a sequence of standard summary tables displayed in the console
#plot(x = results1, k = 10, pause = F) #produces a sequence of standard summary plots displayed in the plots window
#for individual plots assign the above to an object (p <- ) and then call individual plots (1-5, e.g. p[5])
p <- plot(x = results1, k = 10, pause = F)
p[1]
# ggsave(here("Figs/Suppl_Figs", "SFig9.png"),
#        width = 8,
#        height = 6)
p[2]
# ggsave(here("Figs/Suppl_Figs", "SFig10.png"),
#        width = 8,
#        height = 6)
```

```{r table - counts by journal}
# Publication journals
knitr::kable(select(bib_data,
                    JI), caption = "Table SX. counts of numbers of publications per journal") %>%
  kable_paper(bootstrap_options = "striped", full_width = F)
```

## Making keyword co-occurrence matrix / Keywords network

```{r keyword co-occurance matrix, echo = FALSE}

# pdf(file="./Figs/Suppl_Figs/SFig11.pdf",
#     width = 6, 
#     height = 5, 
#     pointsize = 10,
#     family = "Helvetica",
#     fonts = c("Helvetica"))
# par(mfrow=c(1,1), mar=c(2,4,2,4))
NetMatrix_keywords <- 
  biblioNetwork(bib_data, 
                analysis = "co-occurrences", 
                network = "keywords", 
                sep = ";")

NetMatrix_keywords_plot <- 
  networkPlot(NetMatrix_keywords,
              normalize="association", n = 20,
              Title = "Keyword co-occurrences", type = "fruchterman",
              size.cex = TRUE, size = 10,
              remove.multiple = F,
              edgesize = 3, 
              labelsize = 2, 
              label.cex = TRUE,
              edges.min = 1,
              label.n = 30, 
              alpha = 0.3) #adjust number and size of labels, as needed, etc.
# dev.off()

#str(NetMatrix_keywords_plot)
#res <- thematicMap(net, NetMatrix_keywords, S)
#plot(res$map)
```

## Co-word Analysis through Correspondence Analysis

```{r co-word analysis through correspondence analysis}
suppressWarnings(
conceptualStructure(bib_data,
                    method = "MCA",
                    field = "ID", 
                    minDegree = 15,
                    clust = 5,
                    stemming = FALSE,
                    labelsize = 15,
                    documents = 50)
)

# ggsave(here("Figs/Suppl_Figs", "SFig12.png"),
#        width = 12,
#        height = 9)
```

## Thematic map based on keywords

```{r thematic map based on keywords}

#pdf(file="./plots/figure_thematic_map.pdf", width = 5, height = 5, pointsize = 8, family = "Helvetica", fonts = c("Helvetica"))
# par(mfrow=c(1,1), mar=c(0,2,0,2))

map_thematic <- 
  thematicMap(bib_data, 
              field = "ID", 
              n = 1000, 
              minfreq = 5,  
              size = 0.5, 
              n.labels = 1, 
              repel = TRUE)

plot(map_thematic$map)
#dev.off()

# ggsave(here("Figs/Suppl_Figs", "SFig13.png"),
#        width = 9,
#        height = 8)

```

## Author collaboration network

Links between review authors based on their co-authorship on these reviews. Currently, there are too few articles included for the connections between the clusters (publications) to be visible, although it looks like one set of authors co-authored two of the eight reviews from the pilot set.

```{r author collaboration network}

NetMatrix_authors <- 
  biblioNetwork(bib_data, analysis = "collaboration",  network = "authors", sep = ";")

NetMatrix_authors_plot <- 
  networkPlot(NetMatrix_authors,
              n = 50,
              Title = "Author collaboration", 
              type = "auto", 
              size = 2, 
              size.cex = TRUE, 
              edgesize = 10, 
              labelsize = 1.1) #note there are potentially some mistakes in authors initials

# ggsave(here("Figs/Suppl_Figs", "SFig14.png"),
#        width = 10,
#        height = 8)
```

## Country collaboration network

Links between countries, based on the institutional affiliations of the review authors.

```{r country collaboration network 1}

# pdf(file="Figs/Suppl_Figs/country_collaboration_network2.pdf",width = 7, height = 5, pointsize = 10, family = "Helvetica", fonts = c("Helvetica"))
#par(mfrow=c(1,1), mar=c(2,3,2,3))

NetMatrix_country <- 
  biblioNetwork(bib_data, analysis = "collaboration", network = "countries", sep = ";")

NetMatrix_country_plot <- 
  networkPlot(NetMatrix_country,
              n = 50, 
              cluster = "optimal",
              Title = "Country collaborations",
              type = "mds", 
              size.cex = TRUE,
              size = 10,
              remove.multiple=FALSE, 
              label.cex = TRUE,
              label.color = "black",
              labelsize = 3.5,
              edgesize = 2,
              halo = FALSE,
              remove.isolates = TRUE)

# dev.off()

```

```{r country collaboration network 2, eval = FALSE}
NetMatrix_country_plot2 <- 
  networkPlot(NetMatrix_country,
              n = dim(NetMatrix_country)[1], 
              Title = "Country collaboration",
              type = "circle", 
              size = 10,
              size.cex = TRUE,
              remove.multiple = FALSE, 
              edgesize = 7,
              labelsize = 1.3,
              cluster = "none")

```

## Analyzing lists of references (cited works)

```{r bibliometrix test with refs, eval = TRUE, warning = FALSE}
 
# analyzing lists of references 
CR <- 
  citations(bib_data, 
            field = "article", 
            sep = ";") #list of most cited articles

 cbind(CR$Cited[1:10]) #ten most cited articles
 
CR <- 
  citations(bib_data, 
            field = "author",
            sep = ";")

cbind(CR$Cited[1:10]) #ten most cited authors
```

## Article (References) co-citation analysis

```{r bibliometrix co-citation network 1, eval = TRUE, warning = FALSE}

# classical article coupling network: Citation network
NetMatrix_cocitation <- 
  biblioNetwork(bib_data, 
                analysis = "co-citation",
                network = "references", 
                sep = "; ")

NetMatrix_cocitation_plot <- 
  networkPlot(NetMatrix_cocitation, 
              n = 30, 
              Title = "Co-citation Network", 
              type = "fruchterman", 
              size.cex = TRUE ,
              size = 10, 
              remove.multiple = FALSE, 
              labelsize = 1,
              edgesize = 10) #plot the network

```

## Historical co-citation network

Currently not enough papers to create this network plot.

```{r bibliometrix co-citation network 2, eval = TRUE, warning = FALSE}

histResults <- 
  histNetwork(bib_data, 
              sep = ";") 
# not possible now - Found 2 documents with no empty Local Citations (LCS)

# pdf(file="./plots/Figure_hstorical_network.pdf", width=8, height=8, pointsize=10)
# par(mfrow=c(1,1), mar=c(0,0,0,0))
histPlot(histResults, n=20, size = 5, labelsize = 4) 
# dev.off()

```

------------------------------------------------------------------------

## Cross-objective insights

We will investigate how review type, indicators of review quality or transparency are related other review properties, such as publication date, main review topic and subject, etc. Below, we provide a few examples where data belonging to different objectives is use together to answer these additional questions.

```{r simple plots review type vs Human_animal_environment}
# Review_type_claimed vs. Human_animal_environment contingency table
#table(mdata$Review_type_claimed) #needs cleaning
mdata$Review_type_claimed <- tolower(mdata$Review_type_claimed) 

t1 <- 
  mdata %>% 
  count(Human_animal_environment, Review_type_claimed)

# barplot of claimed review type vs. subject

ggplot(t1, aes(x = Review_type_claimed, y = n)) +
  labs(title = expression("Review type and subject")) + #~bold(A.)~' Type and subject'
  coord_flip()  +
  scale_fill_brewer() +
  geom_col(aes(fill = Human_animal_environment), width = 0.7) + 
  theme_light() +
  theme(legend.position = "bottom", 
        legend.box.background = element_rect(colour = "black"), 
        legend.title = element_blank(),  
        legend.text=element_text(size = 4), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_blank())

#ggsave(here("plots","figure_barplot_type_subject.pdf"), width = 4, height = 4, units = "cm", scale = 2, device = cairo_pdf)

```

```{r other simple plots, eval = FALSE}
## Code for other simple plots with two crossed variables (not run for pilot data)

# Barplot example Review_type_claimed vs. Human_animal_environment contingency table
t1 <- 
  mdata %>% 
  count(Human_animal_environment, Review_type_claimed)

ggplot(t1, aes(x = Human_animal_environment, y = n)) +
 coord_flip()  +
 theme(legend.position = "top") +
 geom_col(aes(fill = Review_type_claimed), width = 0.7)

ggplot(t1, aes(x = Review_type_claimed, y = n)) +
 coord_flip()  +
 theme(legend.position = "top") +
 geom_col(aes(fill = Human_animal_environment), width = 0.7)

# Heatmap example (it will look better with more data points)
t2 <- xtabs(~Review_type_claimed+Human_animal_environment, data = mdata)  #contingency table
#heatmap(t2, Colv = NA, Rowv = NA, scale="column", col=cm.colors(256), margins = c(15, 25)) #heatmap
heatmap(t2, Colv = NA, Rowv = NA, scale="column", col=heat.colors(12, rev=TRUE, alpha = 0.6), margins = c(15, 25)) #heatmap

#different vesion with side colour bars
#rc <- rainbow(nrow(t2), start = 0, end = .3)
#cc <- rainbow(ncol(t2), start = 0, end = .3)
#heatmap(t2, Colv = NA, Rowv = NA, scale="column", RowSideColors = rc, ColSideColors = cc, margins = c(15, 25)) #heatmap

```

##Time-trends

### Journals

```{r}
top_journals <- mdata %>% 
  group_by(Journal) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  head(10)

top_journals$Journal <- reorder(top_journals$Journal, top_journals$count)

top10_journals <- ggplot(top_journals, aes(x = Journal)) +
  geom_col(aes(fill = "", y = count), width = 0.7) +
  theme_light() +
  labs(title = expression("Top 10 journals")) + 
  coord_flip()+
  scale_y_continuous(name = "Article count",
                     breaks = seq(0, max(top_journals$count), by = 2)) +
  scale_fill_manual(values = c("#919191")) +
  theme(legend.position = "none",
        axis.title.x = element_text(size = 12),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 12))
top10_journals

# ggsave(here("R_data", "plot_top10_journals.png"),
#        width = 8,
#        height = 6)
```

### Top 10 journals

```{r}
mdata %>% 
  group_by(Journal) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  head(10)

top_journals <- mdata %>% 
  filter(!is.na(Journal) & Journal %in% c("environmental research",
                                          "international journal of environmental research and public health",
                                          "science of the total environment",
                                          "environment international",
                                          "environmental health perspectives",
                                          "critical reviews in toxicology",
                                          "chemosphere",
                                          "environmental science and pollution research",
                                          "journal of toxicology and environmental health",
                                          "environmental science & technology")) %>%
  group_by(Journal) %>% 
  count(Publication_year) %>%
  mutate(cumulative = cumsum(n))

time_trend_journals <- top_journals %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = Journal)) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = Journal), size = 3, shape = 21, fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3.5, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 80, by = 10),
                    minor_breaks = NULL
                    ) +
  ggtitle("Time trend") +
  theme(plot.title = element_text(size = 14,
                                  hjust = 0.5),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 8, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 11,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 12,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 12,
                                   hjust = 0.5)) +
  labs(color = "Journal")

time_trend_journals
# ggsave(here("R_data", "time_trend_journals.png"),
#        width = 8,
#        height = 6)
```

### Top 10 journals and Others

```{r}
mdata_journals <- mdata %>% 
  filter(!is.na(Journal)) %>% 
  mutate(Journals = ifelse(Journal %in% c("environmental research",
                                          "international journal of environmental research and public health",
                                          "science of the total environment",
                                          "environment international",
                                          "environmental health perspectives",
                                          "critical reviews in toxicology",
                                          "chemosphere",
                                          "environmental science and pollution research",
                                          "journal of toxicology and environmental health",
                                          "environmental science & technology"),
                           "Top 10", "Others")) %>%
  group_by(Journals) %>% 
  count(Publication_year) %>%
  mutate(cumulative = cumsum(n))

time_trend_top_journals <- mdata_journals %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Journals, - cumulative))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = Journals), size = 3, shape = 21, fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3.5, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 80, by = 10),
                    minor_breaks = NULL
                    ) +
  ggtitle("Time trend") +
  theme(plot.title = element_text(size = 14,
                                  hjust = 0.5),
       axis.text.x = element_text(size = 10,
                                  margin = margin(t = 8, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 11,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 12,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 12,
                                   hjust = 0.5)) +
  labs(color = "Journals")

time_trend_top_journals
# ggsave(here("R_data", "time_trend_journals2.png"),
#        width = 8,
#        height = 6)
```


### Country first author

```{r}
country_trend <- mdata %>% 
  group_by(Country_firstAuthor) %>% 
  filter(Country_firstAuthor %in% c("USA",
                                    "China",
                                    "Italy",
                                    "Spain",
                                    "Denmark",
                                    "Finland",
                                    "Norway",
                                    "Australia",
                                    "Brazil",
                                    "Canada",
                                    "France",
                                    "South Korea")) %>% #Reduce to countries with more than 1 published review
  count(Publication_year) %>% 
  mutate(cumulative = cumsum(n))

trend_countries <- country_trend %>%
  ggplot(aes(x = Publication_year,
             y = cumulative,
             color = reorder(Country_firstAuthor, -cumulative))) +
  geom_line(size = 0.7) + 
  geom_point(aes(color = Country_firstAuthor), size = 3, shape = 21, fill = "white") +
  geom_text(aes(label = n, x = Publication_year, y = cumulative), 
            size = 3.5, 
            hjust = 1.2,
            vjust = -0.5) +
  scale_x_continuous(name = "Year",
                     breaks = seq(2011, 2022, by = 1),
                     minor_breaks = NULL) +
  scale_y_continuous(name = "Number of published systematic reviews",
                    breaks = seq(0, 40, by = 10),
                    minor_breaks = NULL
                    ) +
  ggtitle("Time trend") + 
  theme(plot.title = element_text(size = 14,
                                  hjust = 0.5),
       axis.text.x = element_text(size = 11,
                                  margin = margin(t = 5, 
                                                  r = 0,
                                                  l = 0),
                                  angle = 45),
       axis.text.y = element_text(size = 11,
                                  margin = margin(t = 0, 
                                                  r = 5, 
                                                  l = 5)),
       axis.title.x = element_text(size = 12,
                                   hjust = 0.5),
       axis.title.y = element_text(size = 12,
                                   hjust = 0.5)) +
  labs(color = "Country first author")

trend_countries
# ggsave(here("R_data", "time_trend_countries.png"),
#        width = 8,
#        height = 6)
```

## Country collaboration

Making the plot without getting rid of collabs with the same country
```{r, echo = FALSE, results = 'hide'}
NetMatrix2 <- biblioNetwork(bib_data, 
                            analysis = "collaboration",
                            network = "countries", 
                            sep = ";")

net_matrix2 <- as.matrix(NetMatrix2)

#net_matrix2 <- net_matrix2[rownames(NetMatrix2), countries]
#diag(net_matrix2) <- 0 #get rid of collaboration with same country

#net_matrix2

# getting rid of lower triangle (as this is duplication of info)
net_matrix2[lower.tri(net_matrix2)] <- 0 
#colnames(net_matrix2) - change to title case:
colnames(net_matrix2) <- str_to_title(colnames(net_matrix2))
#rownames(net_matrix2) - change to title case:
rownames(net_matrix2) <- str_to_title(rownames(net_matrix2))
#Fix "Usa" to "USA" :
colnames(net_matrix2)[colnames(net_matrix2) == "Usa"] <- "USA"
rownames(net_matrix2)[rownames(net_matrix2) == "Usa"] <- "USA"
#change "UNITED KINGDOM" to "UK" for easier plotting:
colnames(net_matrix2)[colnames(net_matrix2) == "United Kingdom"] <- "UK"
rownames(net_matrix2)[rownames(net_matrix2) == "United Kingdom"] <- "UK"

circos.clear()

my.cols2 <- c(USA = "#00FFFF",
              China = "#89CFF0",
              Spain = "#7393B3", 
              Denmark = "#088F8F", 
              Italy = "#9FE2BF",
              France = "#EADDCA",
              Sweden = "#E1C16E",
              Canada = "#CD7F32", 
              Norway = "#E30B5C",
              UK = "#DAA06D", 
              Korea = "#800020", 
              Greece = "#E97451", 
              Germany = "#F0E68C",
              Australia = "#808000", 
              Brazil = "#FFAC1C", 
              Finland = "#E3963E",
              Austria = "#FBCEB1", 
              Belgium = "#FFC000", 
              Malaysia = "#F4BB44",
              Netherlands = "#FFE5B4", 
              Poland = "#FF4433",
              Switzerland = "#FA8072",
              Romania = "#FFF5EE",
              Slovenia = "#9F2B68",
              Uganda = "#DE3163",
              Cyprus = "#811331",
              Hong_Kong = "#DC143C",
              Japan = "#AA336A", 
              Czech_Republic = "#C9A9A6", 
              Ghana = "#FF69B4",
              Hungary = "#673147", 
              India = "#A52A2A" , 
              Israel = "#D8BFD8", 
              Kenya = "#DA70D6",
              Luxembourg = "#770737",
              Mexico = "#E0B0FF",
              Monaco = "#CCCCFF", 
              Portugal = "#A95C68", 
              Saudi_Arabia = "#51414F", 
              Singapore = "#BDB5D5", 
              Slovakia = "#FAF9F6",
              South_Africa = "#EEDC82", 
              Tanzania = "#DAA520", 
              Zimbabwe = "#F0E68C")

colnames(net_matrix2)[colnames(net_matrix2) == "Hong Kong"] <- "Hong_Kong"
rownames(net_matrix2)[rownames(net_matrix2) == "Hong Kong"] <- "Hong_Kong"
colnames(net_matrix2)[colnames(net_matrix2) == "Czech Republic"] <- "Czech_Republic"
rownames(net_matrix2)[rownames(net_matrix2) == "Czech Republic"] <- "Czech_Republic"
colnames(net_matrix2)[colnames(net_matrix2) == "Saudi Arabia"] <- "Saudi_Arabia"
rownames(net_matrix2)[rownames(net_matrix2) == "Saudi Arabia"] <- "Saudi_Arabia"
colnames(net_matrix2)[colnames(net_matrix2) == "South Africa"] <- "South_Africa"
rownames(net_matrix2)[rownames(net_matrix2) == "South Africa"] <- "South_Africa"



fig1 <- chordDiagram(net_matrix2,
               annotationTrack = "grid",
               preAllocateTracks = 1, 
               grid.col = my.cols2
  )


circos.trackPlotRegion(track.index = 1, 
                       panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim),
              ylim[1] + 0.1, 
              sector.name, 
              facing = "clockwise", 
              niceFacing = TRUE,
              adj = c(0, 0.5),
              cex = 0.8)
  #circos.axis(h = FALSE, 
              #major.at = NULL, 
              #labels.cex = 0.6,
              #minor.ticks = FALSE,
             # major.tick.length = NULL, 
              #sector.index = sector.name,
              #track.index = 2,
              #labels.pos.adjust = TRUE)
},
bg.border = NA)

fig1
```

Making the same plot but with less countries
```{r, echo = FALSE, results = 'hide'}
net_matrix2 <- net_matrix2[-c(44 : 32), -c(44 : 32)]
net_matrix2 <- net_matrix2[-c(30, 29, 25, 23), -c(30, 29, 25, 23)]
net_matrix2 <- net_matrix2[-c(27), -c(27)]

#pdf(here("R", "Country collabs_1.pdf"), width = 10, height = 10)
fig2 <- chordDiagram(net_matrix2,
               annotationTrack = "grid",
               preAllocateTracks = 1, 
               grid.col = my.cols2
  )


circos.trackPlotRegion(track.index = 1, 
                       panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim),
              ylim[1] + 0.1, 
              sector.name, 
              facing = "clockwise", 
              niceFacing = TRUE,
              adj = c(0, 0.5),
              cex = 1.2)
  circos.axis(h = "top",
              labels.cex = 0.5,
              major.tick.percentage = 0.2, 
              sector.index = sector.name,
              track.index = 2)
  },
  bg.border = NA)
#title("Country collaborations", font.main = 1, cex.main = 1.8)

#dev.off()

fig2
```

Making the plot getting rid of collabs with the same country

```{r}
net_matrix3 <- net_matrix2
diag(net_matrix3) <- 0 #get rid of collaboration with same country

# pdf(here("R_data", "inter_countries_collab.pdf"), width = 21, height = 21)

fig3 <- chordDiagram(net_matrix3,
               annotationTrack = "grid",
               preAllocateTracks = 1, 
               grid.col = my.cols2)

circos.trackPlotRegion(track.index = 1, 
                       panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim),
              ylim[1] + 0.1, 
              sector.name, 
              facing = "clockwise", 
              niceFacing = TRUE,
              adj = c(0, 0.5),
              cex = 3)
  circos.axis(h = "top",
              labels.cex = 0.5,
              major.tick.percentage = 0.2, 
              sector.index = sector.name,
              track.index = 2)
},
bg.border = NA)
#title("Country collaborations", font.main = 1, cex.main = 3, adj = 0.5, line = -1)
# dev.off()
fig3
```


Panel 
Saving panel as a PDF
```{r, eval = FALSE}
pdf(here("Figs", "Country_collabs.pdf"), width = 6, height = 9)

layout(matrix(1:2, 1, 2))
par(mfrow = c(2, 1),
    mar = c(1, 1, 2.1, 1), 
    bg = rgb(1, 1, 1, 0.1),
    adj = 0, 
    cex = 0.6)

fig2 <- chordDiagram(net_matrix2,
               annotationTrack = "grid",
               preAllocateTracks = 1, 
               grid.col = my.cols2
  )

circos.trackPlotRegion(track.index = 1, 
                       panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim),
              ylim[1] + 0.1, 
              sector.name, 
              facing = "clockwise", 
              niceFacing = TRUE,
              adj = c(-0.1, 0.5),
              cex = 1.2)
  circos.axis(h = "top",
              labels.cex = 0.5,
              major.tick.length = 0.2, 
              sector.index = sector.name,
              track.index = 2)
},
bg.border = NA)
title("A",font.main = 1, cex.main = 2.5)


fig3 <- chordDiagram(net_matrix3,
               annotationTrack = "grid",
               preAllocateTracks = 1, 
               grid.col = my.cols2
  )

circos.trackPlotRegion(track.index = 1, 
                       panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim),
              ylim[1] + 0.1, 
              sector.name, 
              facing = "clockwise", 
              niceFacing = TRUE,
              adj = c(-0.1, 0.3),
              cex = 1.2)
  circos.axis(h = "top",
              labels.cex = 0.5,
              major.tick.length = 0.2, 
              sector.index = sector.name,
              track.index = 2)
},
bg.border = NA)
title("B", font.main = 1, cex.main = 2.5)

dev.off()
```